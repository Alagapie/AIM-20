{% extends "base.html" %}

{% block content %}
<div class="ai-tutor-container">
    <div class="container-fluid">
        <div class="row">
            <!-- Main Chat Area -->
            <div class="col-md-8 main-chat-area">
                <div class="chat-header">
                    <div class="header-main">
                        <h3 class="chat-title">
                            <i class="fas fa-graduation-cap text-primary me-2"></i>
                            AI Study Assistant
                        </h3>
                        <div class="header-subtitle">
                            Your intelligent learning companion powered by advanced AI
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="getStudyTip()">
                            <i class="fas fa-lightbulb me-1"></i>Study Tip
                        </button>
                        <button class="btn btn-sm btn-outline-success me-2" onclick="suggestTopics()">
                            <i class="fas fa-list me-1"></i>Suggest Topics
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearHistory()">
                            <i class="fas fa-trash me-1"></i>Clear History
                        </button>
                    </div>
                </div>

                <div class="chat-messages-container">
                    <!-- Scroll to Bottom Button -->
                    <button class="scroll-to-bottom" id="scrollToBottom" style="display: none;" onclick="scrollToBottom()">
                        <i class="fas fa-chevron-down"></i>
                    </button>

                    <div class="chat-messages" id="chatMessages">
                        {% if chats_by_date %}
                            {% for date, chats in chats_by_date.items() %}
                            <div class="date-separator">
                                <span class="date-badge">{{ date }}</span>
                            </div>
                            {% for chat in chats %}
                            <!-- User Message -->
                            <div class="message user-message">
                                <div class="message-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="message-content">
                                    <div class="message-bubble user-bubble">
                                        <div class="message-text user-text">{{ chat.user_message }}</div>
                                        <div class="message-time user-time">{{ chat.created_at.strftime('%H:%M') }}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- AI Message -->
                            <div class="message ai-message">
                                <div class="message-avatar ai-avatar">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div class="message-content">
                                    <div class="message-bubble ai-bubble">
                                        <div class="message-text ai-response" data-message-text="{{ chat.ai_response | replace("'", "\\'") | replace('"', '\\"') | replace('\n', ' ') | replace('\r', '') }}">{{ chat.ai_response | safe }}</div>
                                        <div class="message-time ai-time">{{ chat.created_at.strftime('%H:%M') }}</div>
                                        <button class="message-speak-btn message-tts-btn" data-message-text="{{ chat.ai_response | replace("'", "\\'") | replace('"', '\\"') | replace('\n', ' ') | replace('\r', '') }}" title="Speak this message">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% endfor %}
                        {% else %}
                        <!-- Welcome Message -->
                        <div class="welcome-container">
                            <div class="welcome-content">
                                <div class="welcome-icon">
                                    <i class="fas fa-brain fa-3x text-primary"></i>
                                </div>
                                <h4 class="welcome-title">Welcome to AI Study Assistant!</h4>
                                <p class="welcome-text">
                                    I'm here to help you excel in your studies. Ask me anything about subjects,
                                    study techniques, time management, or academic challenges.
                                </p>
                                <div class="welcome-examples">
                                    <p class="examples-title">Try asking:</p>
                                    <div class="example-buttons">
                                        <button class="btn btn-outline-primary btn-sm me-2 mb-2" onclick="useExample('How can I study math more effectively?')">
                                            üìê Math Study Tips
                                        </button>
                                        <button class="btn btn-outline-success btn-sm me-2 mb-2" onclick="useExample('Help me create a study schedule')">
                                            ‚è∞ Study Schedule
                                        </button>
                                        <button class="btn btn-outline-info btn-sm me-2 mb-2" onclick="useExample('How do I stay motivated to study?')">
                                            üî• Motivation Tips
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Typing Indicator -->
                    <div class="typing-indicator" id="typingIndicator" style="display: none;">
                        <div class="message ai-message">
                            <div class="message-avatar ai-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <div class="message-bubble ai-bubble">
                                    <div class="typing-dots">
                                        <span></span>
                                        <span></span>
                                        <span></span>
                                    </div>
                                    <div class="typing-text">AI is thinking...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="chat-input-container">
                    <div class="input-group">
                        <button class="btn btn-outline-secondary voice-btn me-2" id="voiceInputBtn" onclick="startVoiceInput()" title="Voice Input">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <input type="text" class="form-control chat-input" id="chatInput"
                                        placeholder="Ask me anything about your studies..."
                                        autocomplete="off"
                                        maxlength="1000">
                        <button class="btn btn-primary send-btn" id="sendButton">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="input-footer">
                        <small class="text-muted">
                            Press Enter to send ‚Ä¢ Shift + Enter for new line ‚Ä¢ üé§ Voice input
                        </small>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-md-4 chat-sidebar">
                <div class="sidebar-wrapper">
                    <!-- Header -->
                    <div class="sidebar-header">
                        <div class="sidebar-avatar">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div class="sidebar-title">
                            <h4>Smart Study Hub</h4>
                            <p>Enhanced Learning</p>
                        </div>
                    </div>

                    <!-- Document Upload Section -->
                    <div class="sidebar-card upload-card">
                        <div class="card-header">
                            <i class="fas fa-file-upload"></i>
                            <span>Document Intelligence</span>
                        </div>
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-content">
                                <div class="upload-visual">
                                    <div class="upload-circle">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <div class="upload-pulse"></div>
                                </div>
                                <h5 class="upload-title">Upload Study Materials</h5>
                                <p class="upload-description">Drop files or click to browse</p>
                                <div class="upload-specs">
                                    <span class="spec-item">
                                        <i class="fas fa-file-pdf"></i> PDF
                                    </span>
                                    <span class="spec-item">
                                        <i class="fas fa-file-word"></i> DOC/DOCX
                                    </span>
                                    <span class="spec-item">
                                        <i class="fas fa-file-text"></i> TXT
                                    </span>
                                    <span class="spec-item">
                                        <i class="fas fa-layer-group"></i> Max 4 files
                                    </span>
                                    <span class="spec-item">
                                        <i class="fas fa-weight-hanging"></i> 50MB each
                                    </span>
                                </div>
                                <input type="file" id="fileInput" class="file-input" accept=".pdf,.docx,.doc,.txt" multiple>
                                <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                                    <i class="fas fa-plus me-2"></i>
                                    Choose Documents
                                </button>
                            </div>
                        </div>
                        <div class="uploaded-files" id="uploadedFiles">
                            <div class="files-header">
                                <span>Uploaded Files</span>
                                <span class="file-count" id="fileCount">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions Card -->
                    <div class="sidebar-card actions-card">
                        <div class="card-header">
                            <i class="fas fa-bolt"></i>
                            <span>Quick Actions</span>
                        </div>
                        <div class="action-grid">
                            <button class="action-tile" onclick="getStudyTip()">
                                <div class="tile-icon">
                                    <i class="fas fa-lightbulb"></i>
                                </div>
                                <div class="tile-content">
                                    <span class="tile-title">Study Tip</span>
                                    <span class="tile-desc">Daily wisdom</span>
                                </div>
                            </button>

                            <button class="action-tile" onclick="suggestTopics()">
                                <div class="tile-icon">
                                    <i class="fas fa-compass"></i>
                                </div>
                                <div class="tile-content">
                                    <span class="tile-title">Explore</span>
                                    <span class="tile-desc">Topic suggestions</span>
                                </div>
                            </button>

                            <button class="action-tile" onclick="useExample('Help me create a study plan')">
                                <div class="tile-icon">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                                <div class="tile-content">
                                    <span class="tile-title">Plan</span>
                                    <span class="tile-desc">Study schedule</span>
                                </div>
                            </button>

                            <button class="action-tile" onclick="useExample('Motivate me to study')">
                                <div class="tile-icon">
                                    <i class="fas fa-fire"></i>
                                </div>
                                <div class="tile-content">
                                    <span class="tile-title">Motivate</span>
                                    <span class="tile-desc">Get inspired</span>
                                </div>
                            </button>

                            <button class="action-tile" onclick="openQuizModal()">
                                <div class="tile-icon">
                                    <i class="fas fa-brain"></i>
                                </div>
                                <div class="tile-content">
                                    <span class="tile-title">Take Quiz</span>
                                    <span class="tile-desc">Test your knowledge</span>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Progress Card -->
                    <div class="sidebar-card progress-card">
                        <div class="card-header">
                            <i class="fas fa-chart-line"></i>
                            <span>Learning Progress</span>
                        </div>
                        <div class="progress-content">
                            <div class="progress-metric">
                                <div class="metric-icon">
                                    <i class="fas fa-brain"></i>
                                </div>
                                <div class="metric-data">
                                    <div class="metric-value">
                                        {% set total_sessions = 0 %}
                                        {% for date, chats in chats_by_date.items() %}
                                            {% set total_sessions = total_sessions + chats|length %}
                                        {% endfor %}
                                        {{ total_sessions }}
                                    </div>
                                    <div class="metric-label">Total Conversations</div>
                                </div>
                            </div>

                            <div class="progress-metric">
                                <div class="metric-icon">
                                    <i class="fas fa-question-circle"></i>
                                </div>
                                <div class="metric-data">
                                    <div class="metric-value">{{ chats_by_date | length }}</div>
                                    <div class="metric-label">Active Days</div>
                                </div>
                            </div>

                            <div class="progress-metric">
                                <div class="metric-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="metric-data">
                                    <div class="metric-value">
                                        {% if session.get('uploaded_documents') %}
                                            {{ session['uploaded_documents'] | length }}
                                        {% else %}
                                            0
                                        {% endif %}
                                    </div>
                                    <div class="metric-label">Documents Uploaded</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Capabilities Showcase -->
                    <div class="sidebar-card capabilities-card">
                        <div class="card-header">
                            <i class="fas fa-magic"></i>
                            <span>AI Capabilities</span>
                        </div>
                        <div class="capabilities-content">
                            <div class="capabilities-grid">
                                <div class="capability-item">
                                    <div class="capability-icon">
                                        <i class="fas fa-book-open"></i>
                                    </div>
                                    <div class="capability-text">
                                        <div class="capability-title">Subject Mastery</div>
                                        <div class="capability-desc">Expert knowledge across all subjects</div>
                                    </div>
                                </div>

                                <div class="capability-item">
                                    <div class="capability-icon">
                                        <i class="fas fa-brain"></i>
                                    </div>
                                    <div class="capability-text">
                                        <div class="capability-title">Study Strategies</div>
                                        <div class="capability-desc">Proven learning techniques</div>
                                    </div>
                                </div>

                                <div class="capability-item">
                                    <div class="capability-icon">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                    <div class="capability-text">
                                        <div class="capability-title">Document Analysis</div>
                                        <div class="capability-desc">Smart content processing</div>
                                    </div>
                                </div>

                                <div class="capability-item">
                                    <div class="capability-icon">
                                        <i class="fas fa-search"></i>
                                    </div>
                                    <div class="capability-text">
                                        <div class="capability-title">Smart Research</div>
                                        <div class="capability-desc">Intelligent information retrieval</div>
                                    </div>
                                </div>

                                <div class="capability-item">
                                    <div class="capability-icon">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="capability-text">
                                        <div class="capability-title">Time Management</div>
                                        <div class="capability-desc">Productivity optimization</div>
                                    </div>
                                </div>

                                <div class="capability-item">
                                    <div class="capability-icon">
                                        <i class="fas fa-bullseye"></i>
                                    </div>
                                    <div class="capability-text">
                                        <div class="capability-title">Goal Achievement</div>
                                        <div class="capability-desc">Success-oriented guidance</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quiz Modal -->
<div class="modal fade" id="quizModal" tabindex="-1" aria-labelledby="quizModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quizModalLabel">AI Quiz Generator</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Quiz Creation Form -->
                <div id="quizForm">
                    <div class="mb-3">
                        <label for="quizTopic" class="form-label">Topic</label>
                        <input type="text" class="form-control" id="quizTopic" placeholder="e.g., Mathematics, History, Science">
                    </div>
                    <div class="mb-3">
                        <label for="quizSubject" class="form-label">Subject (Optional)</label>
                        <input type="text" class="form-control" id="quizSubject" placeholder="e.g., Algebra, World War II">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="quizDifficulty" class="form-label">Difficulty</label>
                            <select class="form-select" id="quizDifficulty">
                                <option value="beginner">Beginner</option>
                                <option value="intermediate" selected>Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="quizQuestions" class="form-label">Number of Questions</label>
                            <select class="form-select" id="quizQuestions">
                                <option value="5">5 Questions</option>
                                <option value="10" selected>10 Questions</option>
                                <option value="15">15 Questions</option>
                                <option value="20">20 Questions</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Question Types</label>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="multipleChoice" value="multiple_choice" checked>
                                    <label class="form-check-label" for="multipleChoice">
                                        <i class="fas fa-list-ul me-1"></i>Multiple Choice
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="trueFalse" value="true_false" checked>
                                    <label class="form-check-label" for="trueFalse">
                                        <i class="fas fa-check-circle me-1"></i>True/False
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="shortAnswer" value="short_answer">
                                    <label class="form-check-label" for="shortAnswer">
                                        <i class="fas fa-edit me-1"></i>Short Answer
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="fillBlank" value="fill_blank">
                                    <label class="form-check-label" for="fillBlank">
                                        <i class="fas fa-fill-drip me-1"></i>Fill in the Blank
                                    </label>
                                </div>
                            </div>
                        </div>
                        <small class="form-text text-muted">Select at least one question type. Multiple choice and true/false are recommended for automatic grading. Essays require manual review.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Source</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="quizSource" id="sourceTopic" value="topic" checked>
                            <label class="form-check-label" for="sourceTopic">
                                Custom Topic
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="quizSource" id="sourceChat" value="chat">
                            <label class="form-check-label" for="sourceChat">
                                From Recent Conversations
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="quizSource" id="sourceDocument" value="document">
                            <label class="form-check-label" for="sourceDocument">
                                From Uploaded Documents
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Quiz Taking Interface -->
                <div id="quizInterface" style="display: none;">
                    <div class="quiz-header mb-4">
                        <h4 id="quizTitle">Quiz Title</h4>
                        <div class="quiz-progress">
                            <span id="currentQuestion">1</span> / <span id="totalQuestions">10</span>
                            <div class="progress mt-2">
                                <div class="progress-bar" id="quizProgressBar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div id="questionContainer">
                        <!-- Questions will be loaded here -->
                    </div>

                    <div class="quiz-controls mt-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button class="btn btn-secondary" id="prevQuestion" disabled onclick="prevQuestion()">Previous</button>
                                <button class="btn btn-primary" id="nextQuestion" onclick="nextQuestion()">Next</button>
                                <button class="btn btn-success" id="finishQuiz" style="display: none;" onclick="finishQuiz()">Finish Quiz</button>
                            </div>
                            <div>
                                <button class="btn btn-outline-info btn-sm" onclick="downloadQuestions()" title="Download Questions as Word Document">
                                    <i class="fas fa-file-word me-1"></i>Questions
                                </button>
                                <button class="btn btn-outline-success btn-sm" id="downloadAnswersBtn" onclick="downloadAnswers()" title="Download Answers as Word Document">
                                    <i class="fas fa-file-word me-1"></i>Answers
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quiz Results -->
                <div id="quizResults" style="display: none;">
                    <div class="modern-quiz-results">
                        <!-- Header -->
                        <div class="results-header">
                            <div class="score-circle">
                                <div class="score-number" id="finalScore">0%</div>
                                <div class="score-label">Score</div>
                            </div>
                            <h4 class="results-title">üéâ Quiz Complete!</h4>
                        </div>

                        <!-- Stats Cards -->
                        <div class="stats-grid">
                            <div class="stat-card correct">
                                <div class="stat-icon">‚úÖ</div>
                                <div class="stat-value" id="correctAnswers">0</div>
                                <div class="stat-label">Correct</div>
                            </div>
                            <div class="stat-card total">
                                <div class="stat-icon">üìä</div>
                                <div class="stat-value" id="totalQuestionsResult">0</div>
                                <div class="stat-label">Total</div>
                            </div>
                            <div class="stat-card time">
                                <div class="stat-icon">‚è±Ô∏è</div>
                                <div class="stat-value" id="timeTaken">0s</div>
                                <div class="stat-label">Time</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading -->
                <div id="quizLoading" style="display: none;" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="mt-2">Generating your personalized quiz...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="generateQuiz()" id="generateQuizBtn">Generate Quiz</button>
            </div>
        </div>
    </div>
</div>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

/* Professional AI Tutor Styles */
.ai-tutor-container {
    background:
        linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%),
        radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(102, 126, 234, 0.15) 0%, transparent 50%);
    min-height: 100vh;
    padding: 10px;
    position: relative;
    overflow: hidden;
    font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

@media (min-width: 576px) {
    .ai-tutor-container {
        padding: 15px;
    }
}

@media (min-width: 768px) {
    .ai-tutor-container {
        padding: 20px;
    }
}

@media (min-width: 992px) {
    .ai-tutor-container {
        padding: 25px 30px;
    }
}

@media (min-width: 1200px) {
    .ai-tutor-container {
        padding: 30px 35px;
    }
}

.ai-tutor-container::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background:
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><radialGradient id="a" cx="50%" cy="50%"><stop offset="0%" style="stop-color:rgba(255,255,255,0.1)"/><stop offset="100%" style="stop-color:rgba(255,255,255,0)"/></radialGradient></defs><circle cx="200" cy="200" r="150" fill="url(%23a)"/><circle cx="800" cy="300" r="120" fill="url(%23a)"/><circle cx="300" cy="700" r="100" fill="url(%23a)"/><circle cx="700" cy="800" r="130" fill="url(%23a)"/></svg>') no-repeat center,
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400"><defs><pattern id="floating-shapes" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="3" fill="rgba(255,255,255,0.05)"/><rect x="75" y="75" width="6" height="6" fill="rgba(255,255,255,0.03)" transform="rotate(45 78 78)"/><polygon points="50,10 60,40 40,40" fill="rgba(255,255,255,0.04)"/></pattern></defs><rect width="100%" height="100%" fill="url(%23floating-shapes)"/></svg>');
    background-size: 800px 800px, 200px 200px;
    background-position: center, 0 0;
    animation: float 20s ease-in-out infinite;
    pointer-events: none;
    z-index: 0;
}

@keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    33% { transform: translateY(-10px) rotate(1deg); }
    66% { transform: translateY(5px) rotate(-0.5deg); }
}

.ai-tutor-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="%23ffffff" opacity="0.03"/><circle cx="75" cy="75" r="1" fill="%23ffffff" opacity="0.03"/><circle cx="50" cy="10" r="0.5" fill="%23ffffff" opacity="0.02"/><circle cx="10" cy="50" r="0.5" fill="%23ffffff" opacity="0.02"/><circle cx="90" cy="20" r="0.5" fill="%23ffffff" opacity="0.02"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    pointer-events: none;
}

.chat-header {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 249, 250, 0.98) 100%);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 30px 35px;
    border-radius: 20px 20px 0 0;
    border-bottom: 1px solid rgba(102, 126, 234, 0.2);
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0;
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.12);
    position: relative;
    overflow: hidden;
}

.header-main {
    flex: 1;
}

.header-subtitle {
    font-size: 0.95rem;
    color: #718096;
    margin-top: 4px;
    font-weight: 400;
    line-height: 1.4;
    max-width: 400px;
}

.chat-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    animation: headerShimmer 4s infinite;
}

@keyframes headerShimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

.chat-title {
    margin: 0;
    color: #2c3e50;
    font-weight: 700;
    font-size: 1.25rem;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    position: relative;
    z-index: 2;
}

.header-actions {
    display: flex;
    gap: 10px;
    position: relative;
    z-index: 2;
}

.header-actions .btn {
    border-radius: 25px;
    font-weight: 500;
    font-size: 0.875rem;
    padding: 8px 16px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(102, 126, 234, 0.3);
    background: rgba(255, 255, 255, 0.8);
    color: #4a5568;
    backdrop-filter: blur(10px);
}

.header-actions .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.25);
    background: rgba(102, 126, 234, 0.1);
    border-color: rgba(102, 126, 234, 0.4);
}

.header-actions .btn i {
    margin-right: 6px;
    font-size: 0.8rem;
}

.chat-messages-container {
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.95) 100%);
    border: 1px solid rgba(102, 126, 234, 0.1);
    border-top: none;
    border-radius: 0 0 25px 25px;
    height: calc(100vh - 280px);
    max-height: 600px;
    display: flex;
    flex-direction: column;
    margin-bottom: 20px;
    position: relative;
    box-shadow:
        0 20px 40px rgba(102, 126, 234, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@media (max-width: 575px) {
    .chat-messages-container {
        height: calc(100vh - 250px);
        margin-bottom: 15px;
    }
}

@media (min-width: 576px) and (max-width: 767px) {
    .chat-messages-container {
        height: calc(100vh - 260px);
        margin-bottom: 18px;
    }
}

.chat-messages-container:hover {
    box-shadow:
        0 12px 40px rgba(102, 126, 234, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.8),
        inset 0 -1px 0 rgba(0, 0, 0, 0.05);
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

@media (max-width: 575px) {
    .chat-messages {
        padding: 15px;
        gap: 12px;
    }
}

@media (min-width: 576px) and (max-width: 991px) {
    .chat-messages {
        padding: 18px;
        gap: 14px;
    }
}

.date-separator {
    display: flex;
    justify-content: center;
    margin: 20px 0;
}

.date-badge {
    background: #e9ecef;
    color: #6c757d;
    padding: 5px 15px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 500;
}

.message {
    display: flex;
    gap: 12px;
    max-width: 80%;
}

.user-message {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.ai-message {
    align-self: flex-start;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    background: #6c757d;
    color: white;
    font-size: 16px;
}

.ai-avatar {
    background: linear-gradient(135deg, #667eea, #764ba2);
}

.message-bubble {
    padding: 14px 18px;
    border-radius: 22px;
    max-width: 100%;
    word-wrap: break-word;
    position: relative;
    transition: all 0.2s ease;
}

.message-bubble:hover {
    transform: translateY(-1px);
}

.user-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #ffffff;
    border-bottom-right-radius: 8px;
    box-shadow: 0 4px 14px rgba(102, 126, 234, 0.3);
    position: relative;
}

.user-bubble::before {
    content: '';
    position: absolute;
    bottom: -2px;
    right: -2px;
    width: 0;
    height: 0;
    border-left: 8px solid #764ba2;
    border-bottom: 8px solid transparent;
}

.ai-bubble {
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    color: #2d3748;
    border-bottom-left-radius: 8px;
    border: 1px solid rgba(102, 126, 234, 0.1);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
    position: relative;
}

.ai-bubble::before {
    content: '';
    position: absolute;
    bottom: -2px;
    left: -2px;
    width: 0;
    height: 0;
    border-right: 8px solid rgba(255, 255, 255, 0.98);
    border-bottom: 8px solid transparent;
}

.message-text {
    margin-bottom: 5px;
    font-size: 14px;
    line-height: 1.4;
    word-wrap: break-word;
}

.message-text.user-text {
    color: #000000 !important;
    font-weight: 500 !important;
}

.message-text.ai-response {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
    font-size: 14px !important;
    line-height: 1.5 !important;
    color: #2c3e50 !important;
    font-weight: 400;
}

.message-time {
    font-size: 11px;
    opacity: 0.8;
    text-align: right;
}

.message-time.user-time {
    color: rgba(0, 0, 0, 0.6) !important;
}

.message-time.ai-time {
    color: #6c757d !important;
}

/* Individual message TTS button */
.message-speak-btn {
    position: absolute;
    bottom: 45px;
    right: 12px;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
    opacity: 0.7;
}

.message-speak-btn:hover {
    background: rgba(102, 126, 234, 0.25);
    transform: scale(1.15);
    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
    opacity: 1;
}

.message-bubble:hover .message-speak-btn {
    opacity: 1;
}

.message-speak-btn.speaking {
    background: rgba(72, 187, 120, 0.3);
    color: #48bb78;
    animation: pulse 1s infinite;
    opacity: 1;
    transform: scale(1.05);
}

.message-speak-btn.speaking i {
    animation: none;
}

.message-speak-btn:active {
    transform: scale(0.95);
}

/* Welcome Screen */
.welcome-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
}

.welcome-content {
    text-align: center;
    max-width: 500px;
}

.welcome-icon {
    margin-bottom: 20px;
    opacity: 0.8;
}

.welcome-title {
    color: #1a202c;
    margin-bottom: 18px;
    font-weight: 700;
    font-size: 1.5rem;
    letter-spacing: -0.025em;
}

.welcome-text {
    color: #6c757d;
    margin-bottom: 25px;
    line-height: 1.6;
}

.examples-title {
    color: #495057;
    margin-bottom: 15px;
    font-weight: 500;
}

.example-buttons {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
}

/* Typing Indicator */
.typing-indicator {
    padding: 0 20px 15px;
}

.typing-dots {
    display: flex;
    gap: 4px;
    margin-bottom: 8px;
}

.typing-dots span {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #667eea;
    animation: typing 1.4s infinite;
}

.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
    0%, 60%, 100% { opacity: 0.4; }
    30% { opacity: 1; }
}

.typing-text {
    font-size: 13px;
    color: #6c757d;
    font-style: italic;
}

/* Input Area */
.chat-input-container {
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 249, 250, 0.98) 100%);
    border: 1px solid rgba(102, 126, 234, 0.15);
    border-radius: 20px;
    padding: 25px;
    box-shadow:
        0 10px 30px rgba(102, 126, 234, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@media (max-width: 575px) {
    .chat-input-container {
        padding: 18px;
        border-radius: 18px;
    }
}

@media (min-width: 576px) and (max-width: 767px) {
    .chat-input-container {
        padding: 22px;
    }
}

.chat-input-container:hover {
    box-shadow:
        0 6px 20px rgba(102, 126, 234, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    transform: translateY(-1px);
}

.input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.chat-input {
    border: 2px solid #e9ecef;
    border-radius: 25px;
    padding: 12px 20px;
    font-size: 14px;
    transition: border-color 0.2s ease;
}

.chat-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}

.send-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 50%, #45b7d1 100%);
    border: none;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
}

.send-btn:hover {
    transform: scale(1.1) rotate(5deg);
    box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
}

.input-footer {
    text-align: center;
}

.input-footer small {
    font-size: 12px;
}

/* Scroll to Bottom Button */
.scroll-to-bottom {
    position: absolute;
    bottom: 20px;
    right: 20px;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
    z-index: 100;
}

.scroll-to-bottom:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
}

.scroll-to-bottom i {
    font-size: 16px;
}

/* Masterpiece Sidebar */
.chat-sidebar {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.95) 100%);
    backdrop-filter: blur(15px);
    border-left: 3px solid transparent;
    border-image: linear-gradient(180deg, #667eea 0%, #764ba2 50%, #f093fb 100%) 1;
    padding: 25px;
    overflow-y: auto;
    max-height: calc(100vh - 100px);
    position: relative;
}

@media (max-width: 991px) {
    .chat-sidebar {
        padding: 20px;
        max-height: calc(100vh - 80px);
    }
}

@media (max-width: 767px) {
    .chat-sidebar {
        padding: 18px;
        max-height: calc(100vh - 70px);
    }
}

.chat-sidebar::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><defs><radialGradient id="sidebar-bg" cx="50%" cy="50%"><stop offset="0%" style="stop-color:rgba(102, 126, 234, 0.02)"/><stop offset="100%" style="stop-color:rgba(255, 255, 255, 0)"/></radialGradient></defs><circle cx="100" cy="100" r="80" fill="url(%23sidebar-bg)"/><circle cx="40" cy="40" r="30" fill="url(%23sidebar-bg)"/><circle cx="160" cy="160" r="25" fill="url(%23sidebar-bg)"/></svg>');
    pointer-events: none;
    z-index: 0;
}

.sidebar-wrapper {
    position: relative;
    z-index: 1;
}

/* Sidebar Header */
.sidebar-header {
    display: flex;
    align-items: center;
    gap: 18px;
    margin-bottom: 30px;
    padding: 25px;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
    border-radius: 20px;
    border: 1px solid rgba(102, 126, 234, 0.15);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.08);
}

.sidebar-avatar {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.sidebar-title h4 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 700;
    color: #2c3e50;
}

.sidebar-title p {
    margin: 0;
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 500;
}

/* Sidebar Cards */
.sidebar-card {
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 24px;
    margin-bottom: 30px;
    border: 1px solid rgba(102, 126, 234, 0.1);
    box-shadow:
        0 12px 35px rgba(102, 126, 234, 0.08),
        0 0 0 1px rgba(255, 255, 255, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

.sidebar-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
}

.card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px 20px;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    border-bottom: 1px solid rgba(102, 126, 234, 0.1);
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.9rem;
}

.card-header i {
    color: #667eea;
    font-size: 1rem;
}

.sidebar-content {
    position: sticky;
    top: 0;
}

/* Upload Area - Masterpiece Design */
.upload-area {
    border: 2px dashed transparent;
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
    border-image: linear-gradient(45deg, #667eea, #764ba2) 1;
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    margin: 20px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.1);
    backdrop-filter: blur(20px);
    animation: gentleFloat 6s ease-in-out infinite;
}

.upload-area::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
    transition: left 0.5s ease;
}

.upload-area:hover::before {
    left: 100%;
}

.upload-area:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
    border-image: linear-gradient(45deg, #764ba2, #f093fb) 1;
}

.upload-area.dragover {
    border-image: linear-gradient(45deg, #28a745, #20c997) 1;
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%);
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
}

.upload-content {
    position: relative;
    z-index: 2;
}

.upload-visual {
    position: relative;
    margin-bottom: 15px;
}

.upload-circle {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    margin: 0 auto 10px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
}

.upload-area:hover .upload-circle {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.upload-pulse {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80px;
    height: 80px;
    border: 2px solid rgba(102, 126, 234, 0.3);
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
}

@keyframes gentleFloat {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-5px) rotate(0.5deg); }
}

.upload-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 8px;
}

.upload-description {
    color: #6c757d;
    margin-bottom: 15px;
    font-size: 0.9rem;
}

.upload-specs {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    margin-bottom: 20px;
}

.spec-item {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 12px;
    font-size: 0.75rem;
    color: #667eea;
    font-weight: 500;
}

.file-input {
    display: none;
}

.upload-button {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    border-radius: 20px;
    padding: 10px 20px;
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.upload-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

/* Action Tiles - Masterpiece Design */
.action-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.action-tile {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 15px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 249, 250, 0.9) 100%);
    border: 1px solid rgba(102, 126, 234, 0.2);
    border-radius: 15px;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
    text-align: left;
}

.action-tile:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4), 0 0 20px rgba(102, 126, 234, 0.2);
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
    border: 1px solid rgba(102, 126, 234, 0.3);
}

.tile-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1rem;
    flex-shrink: 0;
    transition: all 0.3s ease;
}

.action-tile:hover .tile-icon {
    transform: scale(1.1) rotate(5deg);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.tile-content {
    flex: 1;
}

.tile-title {
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
    font-size: 0.9rem;
}

.tile-desc {
    font-size: 0.75rem;
    color: #6c757d;
    margin: 3px 0 0;
}

/* Uploaded Files */
.uploaded-files {
    padding: 0 20px 20px;
}

.files-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(102, 126, 234, 0.2);
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.9rem;
}

.file-count {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
    font-weight: 700;
}

.file-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 249, 250, 0.9) 100%);
    border-radius: 10px;
    margin-bottom: 8px;
    border: 1px solid rgba(102, 126, 234, 0.2);
    font-size: 0.875rem;
    transition: all 0.2s ease;
    gap: 12px;
}

.file-item:hover {
    transform: translateX(2px);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
}

.file-item.uploading {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%);
    border-color: #ffc107;
}

.file-item.success {
    background: linear-gradient(135deg, rgba(25, 135, 84, 0.1) 0%, rgba(25, 135, 84, 0.05) 100%);
    border-color: #198754;
}

.file-item .file-name {
    flex: 1;
    font-weight: 500;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 0; /* Allow flex item to shrink below content size */
}

.file-item .file-name span:not(.me-2) {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
    min-width: 0;
}

.file-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
}

.file-item .file-size {
    color: #6c757d;
    font-size: 0.75rem;
    margin-right: 12px;
    font-weight: 500;
}

.file-item .remove-file {
    color: #dc3545;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    transition: all 0.2s ease;
    font-size: 0.8rem;
}

.file-item .remove-file:hover {
    background: rgba(220, 53, 69, 0.1);
    transform: scale(1.1);
}

/* Upload Progress */
.upload-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 0 0 10px 10px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    width: 0%;
    transition: width 0.3s ease;
}

/* Professional Progress Metrics */
.progress-content {
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.progress-metric {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    border-radius: 12px;
    border: 1px solid rgba(102, 126, 234, 0.1);
    transition: all 0.3s ease;
}

.progress-metric:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
}

.metric-icon {
    width: 45px;
    height: 45px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.1rem;
    flex-shrink: 0;
}

.metric-data {
    flex: 1;
}

.metric-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: #2c3e50;
    line-height: 1;
    margin-bottom: 2px;
}

.metric-label {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Professional Capabilities */
.capabilities-content {
    padding: 20px;
}

.capabilities-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
}

.capability-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(248, 249, 250, 0.8) 100%);
    border-radius: 10px;
    border: 1px solid rgba(102, 126, 234, 0.1);
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.capability-item:hover {
    transform: translateX(3px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
}

.capability-icon {
    width: 35px;
    height: 35px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.9rem;
    flex-shrink: 0;
}

.capability-text {
    flex: 1;
}

.capability-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 2px;
}

.capability-desc {
    font-size: 0.75rem;
    color: #6c757d;
    line-height: 1.2;
}

/* Language and Voice Controls */
.language-selector {
    display: flex;
    align-items: center;
    margin-right: 15px;
}

.language-selector select {
    border: 1px solid rgba(102, 126, 234, 0.3);
    background: rgba(255, 255, 255, 0.9);
    color: #2c3e50;
    font-size: 0.85rem;
    border-radius: 6px;
}

.language-selector select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}

.voice-btn {
    border: 1px solid rgba(102, 126, 234, 0.3);
    background: rgba(255, 255, 255, 0.95);
    color: #718096;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
}

.voice-btn:hover {
    background: rgba(102, 126, 234, 0.1);
    border-color: rgba(102, 126, 234, 0.5);
    color: #667eea;
    transform: scale(1.08);
    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
}

.voice-btn.active {
    background: rgba(72, 187, 120, 0.15);
    border-color: #48bb78;
    color: #38a169;
    box-shadow: 0 4px 16px rgba(72, 187, 120, 0.3);
}

.voice-btn:active {
    transform: scale(0.95);
}

/* Voice button pulse animation */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* Active voice button state */
.voice-btn.active {
    animation: pulse 1s infinite;
    background: rgba(40, 167, 69, 0.1) !important;
    border-color: #28a745 !important;
}

.voice-btn.active i {
    color: #28a745 !important;
}

#voiceInputBtn:active {
    background: rgba(220, 53, 69, 0.1);
    border-color: #dc3545;
    color: #dc3545;
}

/* Quiz Styling */
.quiz-header {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid rgba(102, 126, 234, 0.2);
}

/* Question Review Cards */
.question-review-card {
    transition: all 0.2s ease;
    font-size: 0.9rem;
}

.question-review-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.question-review-card h6 {
    color: #2c3e50;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
}

.question-review-card p {
    color: #495057;
    line-height: 1.4;
}

.badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.answer-comparison {
    background: rgba(255, 255, 255, 0.8);
    padding: 0.75rem;
    border-radius: 8px;
    border: 1px solid rgba(0, 0, 0, 0.05);
}

.quiz-title {
    color: #2c3e50;
    margin-bottom: 10px;
}

.quiz-progress {
    display: flex;
    align-items: center;
    gap: 15px;
    font-weight: 500;
}

.question-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(102, 126, 234, 0.1);
    margin-bottom: 20px;
}

.question-text {
    color: #2c3e50;
    margin-bottom: 20px;
    line-height: 1.6;
}

.options .form-check {
    margin-bottom: 12px;
    padding: 12px 16px;
    border-radius: 10px;
    transition: all 0.2s ease;
}

.options .form-check:hover {
    background: rgba(102, 126, 234, 0.05);
}

.options .form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
}

.essay-container {
    background: rgba(248, 249, 250, 0.5);
    border-radius: 12px;
    padding: 20px;
    border: 2px solid rgba(102, 126, 234, 0.2);
}

.essay-textarea {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 14px;
    line-height: 1.6;
    resize: vertical;
}

.essay-textarea:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}

.essay-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.quiz-controls {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(102, 126, 234, 0.1);
}

.quiz-controls .btn {
    margin-right: 10px;
    border-radius: 25px;
    font-weight: 500;
    padding: 10px 20px;
    transition: all 0.3s ease;
}

.quiz-controls .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}


.quiz-results {
    text-align: center;
    padding: 40px;
}

.final-score {
    font-size: 4rem;
    font-weight: 700;
    color: #667eea;
    margin: 20px 0;
}

.results-stats {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin: 30px 0;
}

.stat-item h3 {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
}

.stat-item p {
    color: #6c757d;
    margin: 5px 0 0;
    font-weight: 500;
}

/* Responsive */
@media (max-width: 768px) {
    .chat-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }

    .header-actions {
        flex-wrap: wrap;
        justify-content: center;
    }

    .message {
        max-width: 90%;
        gap: 8px;
    }

    .message-avatar {
        width: 35px;
        height: 35px;
        font-size: 14px;
    }

    .message-bubble {
        padding: 10px 14px;
    }

    .chat-messages-container {
        height: calc(100vh - 220px);
    }

    .welcome-container {
        padding: 20px;
    }

    .example-buttons {
        flex-direction: column;
        align-items: center;
    }

    .scroll-to-bottom {
        bottom: 15px;
        right: 15px;
        width: 40px;
        height: 40px;
    }

    .chat-sidebar {
        display: none;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
let isTyping = false;
let recognition = null;
let synthesis = null;
let currentLanguage = 'en'; // Default language
let isVoiceInputActive = false; // Track STT state
let currentUtterance = null; // Track current TTS utterance for pause/resume
let isTTSPaused = false; // Track TTS pause state

// Function to clean up AI response formatting
function cleanAIResponse(text) {
    if (!text) return text;

    // Remove excessive bold formatting (**text**)
    text = text.replace(/\*\*(.*?)\*\*/g, '$1');

    // Clean up bullet points (‚Ä¢ or - or *)
    text = text.replace(/^[‚Ä¢\-\*]\s*/gm, '');

    // Remove excessive line breaks
    text = text.replace(/\n{3,}/g, '\n\n');

    // Clean up common AI response patterns
    text = text.replace(/^Preventive Measures:/gim, 'Preventive Measures:');
    text = text.replace(/^Study Strategies:/gim, 'Study Strategies:');
    text = text.replace(/^Time Management:/gim, 'Time Management:');
    text = text.replace(/^Goal Setting:/gim, 'Goal Setting:');

    return text.trim();
}

document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');
    const chatMessages = document.getElementById('chatMessages');
    const typingIndicator = document.getElementById('typingIndicator');
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadedFiles = document.getElementById('uploadedFiles');

    let uploadedDocuments = [];

    // Initialize speech recognition
    function initSpeechRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = currentLanguage + '-' + currentLanguage.toUpperCase();

            recognition.onstart = function() {
                console.log('Voice recognition started');
                isVoiceInputActive = true;
                const voiceBtn = document.getElementById('voiceInputBtn');
                voiceBtn.classList.add('active');
                voiceBtn.innerHTML = '<i class="fas fa-stop"></i>';
                chatInput.placeholder = 'üé§ Listening... Click to stop';
                chatInput.style.borderColor = '#28a745';
                chatInput.disabled = true;

                // Stop any ongoing TTS when STT starts
                if (synthesis && synthesis.speaking) {
                    synthesis.cancel();
                    console.log('TTS stopped due to STT activation');
                }
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                console.log('Transcript:', transcript);
                chatInput.value = transcript;
                stopVoiceInput();
                // Don't auto-send - let user control when to send
                chatInput.focus();
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                stopVoiceInput();
                if (event.error === 'not-allowed') {
                    alert('Microphone access denied. Please allow microphone access to use voice input.');
                } else if (event.error === 'no-speech') {
                    // No speech detected, just reset UI
                } else {
                    alert('Speech recognition error: ' + event.error);
                }
            };

            recognition.onend = function() {
                console.log('Voice recognition ended');
                stopVoiceInput();
            };
        } else {
            console.warn('Speech recognition not supported');
            // Disable voice input button
            const voiceBtn = document.getElementById('voiceInputBtn');
            if (voiceBtn) {
                voiceBtn.disabled = true;
                voiceBtn.style.opacity = '0.5';
                voiceBtn.title = 'Voice input not supported in this browser';
            }
        }
    }

    function stopVoiceInput() {
        isVoiceInputActive = false;
        const voiceBtn = document.getElementById('voiceInputBtn');
        if (voiceBtn) {
            const icon = voiceBtn.querySelector('i');
            voiceBtn.classList.remove('active');
            icon.className = 'fas fa-microphone';
            chatInput.placeholder = 'Ask me anything about your studies...';
            chatInput.style.borderColor = '#667eea';
            chatInput.disabled = false;
            chatInput.focus();
        }
    }

    // Speech-to-text function
    function startVoiceInput() {
        if (recognition) {
            try {
                // Check if already active
                if (isVoiceInputActive) {
                    recognition.stop();
                    return;
                }

                // Update recognition language
                recognition.lang = currentLanguage + '-' + currentLanguage.toUpperCase();
                recognition.start();
            } catch (error) {
                console.error('Error starting recognition:', error);

                // Try to abort and restart
                try {
                    if (recognition && recognition.abort) {
                        recognition.abort();
                    }
                } catch (e) {}

                setTimeout(() => {
                    try {
                        if (!isVoiceInputActive) {
                            recognition.start();
                        }
                    } catch (e) {
                        console.error('Failed to restart recognition:', e);
                        alert('Voice input failed to start. Please check your microphone permissions and try again.');
                        stopVoiceInput();
                    }
                }, 200);
            }
        } else {
            alert('Speech recognition is not supported in this browser. Please use Chrome, Edge, or Safari.');
        }
    }

    // Initialize speech synthesis
    function initSpeechSynthesis() {
        if ('speechSynthesis' in window) {
            synthesis = window.speechSynthesis;
            console.log('Speech synthesis initialized successfully');

            // Simple initialization - voices will be available when needed
            synthesis.onvoiceschanged = function() {
                console.log('Speech synthesis voices loaded');
            };

        } else {
            console.warn('Speech synthesis not supported in this browser');
        }
    }

    // Text-to-speech function - simplified and robust
    function speakText(text, messageElement = null) {
        if (!synthesis || !text || !text.trim()) {
            console.log('TTS not available or no text');
            return;
        }

        // Don't speak if STT is active
        if (isVoiceInputActive) {
            console.log('TTS blocked: STT is currently active');
            return;
        }

        console.log('Speaking text:', text.substring(0, 50) + '...');

        // Cancel any ongoing speech
        synthesis.cancel();
        isTTSPaused = false;

        const utterance = new SpeechSynthesisUtterance(text);
        currentUtterance = utterance;

        // Simple voice selection - just use the default for the current language
        utterance.lang = currentLanguage;

        // Simple speech settings
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 0.8;

        // Visual feedback
        if (messageElement) {
            const speakBtn = messageElement.querySelector('.message-speak-btn');
            if (speakBtn) {
                speakBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                speakBtn.classList.add('speaking');
            }
        }

        utterance.onstart = function() {
            console.log('Speech started successfully');
        };

        utterance.onend = function() {
            console.log('Speech ended successfully');
            currentUtterance = null;
            isTTSPaused = false;
            // Reset visual feedback
            if (messageElement) {
                const speakBtn = messageElement.querySelector('.message-speak-btn');
                if (speakBtn) {
                    speakBtn.innerHTML = '<i class="fas fa-play"></i>';
                    speakBtn.title = 'Speak this message';
                    speakBtn.classList.remove('speaking');
                }
            }
        };

        utterance.onerror = function(event) {
            console.error('Speech error:', event.error);
            currentUtterance = null;
            isTTSPaused = false;
            // Reset visual feedback on error
            if (messageElement) {
                const speakBtn = messageElement.querySelector('.message-speak-btn');
                if (speakBtn) {
                    speakBtn.innerHTML = '<i class="fas fa-play"></i>';
                    speakBtn.title = 'Speak this message';
                    speakBtn.classList.remove('speaking');
                }
            }
        };

        try {
            synthesis.speak(utterance);
        } catch (error) {
            console.error('Error starting TTS:', error);
        }
    }

    // Stop/pause current TTS
    function stopTTS() {
        if (synthesis && synthesis.speaking) {
            synthesis.cancel();
            currentUtterance = null;
            isTTSPaused = false;
            console.log('TTS stopped');
        }
    }

    // Attach TTS handlers to existing message buttons
    function attachTTSHandlers() {
        document.querySelectorAll('.message-tts-btn').forEach(button => {
            if (!button.hasAttribute('data-handled')) {
                button.setAttribute('data-handled', 'true');
                button.onclick = function() {
                    const messageText = this.getAttribute('data-message-text');
                    const messageDiv = this.closest('.ai-message');

                    if (synthesis && synthesis.speaking) {
                        // If currently speaking, stop it
                        stopTTS();
                        this.innerHTML = '<i class="fas fa-play"></i>';
                        this.title = 'Speak this message';
                        this.classList.remove('speaking');
                    } else {
                        // Start speaking
                        speakText(messageText, messageDiv);
                        this.innerHTML = '<i class="fas fa-stop"></i>';
                        this.title = 'Stop speaking';
                        this.classList.add('speaking');
                    }
                };
            }
        });
    }
    const translations = {
        en: {
            "subtitle": "Your intelligent learning companion powered by advanced AI",
            "study-tip": "Study Tip",
            "suggest-topics": "Suggest Topics",
            "clear-history": "Clear History",
            "chat-placeholder": "Ask me anything about your studies...",
            "document-intelligence": "Document Intelligence",
            "upload-study-materials": "Upload Study Materials",
            "drop-files": "Drop files or click to browse",
            "uploaded-files": "Uploaded Files",
            "quick-actions": "Quick Actions",
            "learning-progress": "Learning Progress",
            "total-conversations": "Total Conversations",
            "active-days": "Active Days",
            "documents-uploaded": "Documents Uploaded",
            "ai-capabilities": "AI Capabilities",
            "subject-mastery": "Subject Mastery",
            "study-strategies": "Study Strategies",
            "document-analysis": "Document Analysis",
            "smart-research": "Smart Research",
            "time-management": "Time Management",
            "goal-achievement": "Goal Achievement",
            "subject-mastery-desc": "Expert knowledge across all subjects",
            "study-strategies-desc": "Proven learning techniques",
            "document-analysis-desc": "Smart content processing",
            "smart-research-desc": "Intelligent information retrieval",
            "time-management-desc": "Productivity optimization",
            "goal-achievement-desc": "Success-oriented guidance"
        },
        es: {
            "subtitle": "Tu compa√±ero de aprendizaje inteligente impulsado por IA avanzada",
            "study-tip": "Consejo de Estudio",
            "suggest-topics": "Sugerir Temas",
            "clear-history": "Borrar Historial",
            "chat-placeholder": "Preg√∫ntame cualquier cosa sobre tus estudios...",
            "document-intelligence": "Inteligencia Documental",
            "upload-study-materials": "Subir Materiales de Estudio",
            "drop-files": "Suelta archivos o haz clic para explorar",
            "uploaded-files": "Archivos Subidos",
            "quick-actions": "Acciones R√°pidas",
            "learning-progress": "Progreso de Aprendizaje",
            "total-conversations": "Conversaciones Totales",
            "active-days": "D√≠as Activos",
            "documents-uploaded": "Documentos Subidos",
            "ai-capabilities": "Capacidades de IA",
            "subject-mastery": "Dominio de Materias",
            "study-strategies": "Estrategias de Estudio",
            "document-analysis": "An√°lisis de Documentos",
            "smart-research": "Investigaci√≥n Inteligente",
            "time-management": "Gesti√≥n del Tiempo",
            "goal-achievement": "Logro de Metas",
            "subject-mastery-desc": "Conocimiento experto en todas las materias",
            "study-strategies-desc": "T√©cnicas de aprendizaje probadas",
            "document-analysis-desc": "Procesamiento inteligente de contenido",
            "smart-research-desc": "Recuperaci√≥n inteligente de informaci√≥n",
            "time-management-desc": "Optimizaci√≥n de productividad",
            "goal-achievement-desc": "Orientaci√≥n orientada al √©xito"
        },
        fr: {
            "subtitle": "Votre compagnon d'apprentissage intelligent aliment√© par l'IA avanc√©e",
            "study-tip": "Conseil d'√âtude",
            "suggest-topics": "Sugg√©rer des Sujets",
            "clear-history": "Effacer l'Historique",
            "chat-placeholder": "Demandez-moi n'importe quoi sur vos √©tudes...",
            "document-intelligence": "Intelligence Documentaire",
            "upload-study-materials": "T√©l√©charger des Mat√©riaux d'√âtude",
            "drop-files": "D√©posez des fichiers ou cliquez pour parcourir",
            "uploaded-files": "Fichiers T√©l√©charg√©s",
            "quick-actions": "Actions Rapides",
            "learning-progress": "Progr√®s d'Apprentissage",
            "total-conversations": "Conversations Totales",
            "active-days": "Jours Actifs",
            "documents-uploaded": "Documents T√©l√©charg√©s",
            "ai-capabilities": "Capacit√©s IA",
            "subject-mastery": "Ma√Ætrise des Sujets",
            "study-strategies": "Strat√©gies d'√âtude",
            "document-analysis": "Analyse de Documents",
            "smart-research": "Recherche Intelligente",
            "time-management": "Gestion du Temps",
            "goal-achievement": "Atteinte des Objectifs",
            "subject-mastery-desc": "Connaissance experte dans toutes les mati√®res",
            "study-strategies-desc": "Techniques d'apprentissage √©prouv√©es",
            "document-analysis-desc": "Traitement intelligent du contenu",
            "smart-research-desc": "R√©cup√©ration intelligente d'informations",
            "time-management-desc": "Optimisation de la productivit√©",
            "goal-achievement-desc": "Orientation ax√©e sur le succ√®s"
        },
        de: {
            "subtitle": "Ihr intelligenter Lernbegleiter, angetrieben von fortschrittlicher KI",
            "study-tip": "Lern-Tipp",
            "suggest-topics": "Themen vorschlagen",
            "clear-history": "Verlauf l√∂schen",
            "chat-placeholder": "Fragen Sie mich alles √ºber Ihre Studien...",
            "document-intelligence": "Dokumentenintelligenz",
            "upload-study-materials": "Lernmaterialien hochladen",
            "drop-files": "Dateien ablegen oder klicken zum Durchsuchen",
            "uploaded-files": "Hochgeladene Dateien",
            "quick-actions": "Schnellaktionen",
            "learning-progress": "Lernfortschritt",
            "total-conversations": "Gesamtunterhaltungen",
            "active-days": "Aktive Tage",
            "documents-uploaded": "Hochgeladene Dokumente",
            "ai-capabilities": "KI-F√§higkeiten",
            "subject-mastery": "Fachkompetenz",
            "study-strategies": "Lernstrategien",
            "document-analysis": "Dokumentenanalyse",
            "smart-research": "Intelligente Recherche",
            "time-management": "Zeitmanagement",
            "goal-achievement": "Ziel erreicht",
            "subject-mastery-desc": "Fachwissen in allen F√§chern",
            "study-strategies-desc": "Bew√§hrte Lerntechniken",
            "document-analysis-desc": "Intelligente Inhaltsverarbeitung",
            "smart-research-desc": "Intelligente Informationsgewinnung",
            "time-management-desc": "Produktivit√§tsoptimierung",
            "goal-achievement-desc": "Erfolgsorientierte Beratung"
        }
    };

    // Language functions
    function changeLanguage() {
        const lang = document.getElementById('languageSelect').value;
        currentLanguage = lang;
        localStorage.setItem('ai_tutor_language', lang);
        updateLanguage();
    }

    function updateLanguage() {
        // Update text elements
        document.querySelectorAll('[data-lang]').forEach(element => {
            const key = element.getAttribute('data-lang');
            if (translations[currentLanguage] && translations[currentLanguage][key]) {
                element.textContent = translations[currentLanguage][key];
            }
        });

        // Update placeholders
        document.querySelectorAll('[data-lang-placeholder]').forEach(element => {
            const key = element.getAttribute('data-lang-placeholder');
            if (translations[currentLanguage] && translations[currentLanguage][key]) {
                element.placeholder = translations[currentLanguage][key];
            }
        });
    }


    // Load existing uploaded documents on page load
    function loadUploadedDocuments() {
        fetch('/ai-tutor/get-uploaded-documents')
            .then(response => response.json())
            .then(data => {
                if (data.documents) {
                    // Clear existing display
                    uploadedFiles.innerHTML = '<div class="files-header"><span>Uploaded Files</span><span class="file-count" id="fileCount">0</span></div>';
                    uploadedDocuments = []; // Reset array

                    data.documents.forEach(doc => {
                        displayExistingFile(doc);
                        uploadedDocuments.push({name: doc.filename, size: 0}); // Size not stored, set to 0
                    });
                    updateFileCount();
                }
            })
            .catch(error => console.error('Error loading documents:', error));
    }

    // File upload functionality
    uploadArea.addEventListener('click', (e) => {
        // Prevent triggering if clicking on the button
        if (e.target.closest('.upload-button')) return;
        fileInput.click();
    });

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
    });

    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
    });

    function handleFiles(files) {
        // Check total documents limit
        if (uploadedDocuments.length + files.length > 4) {
            alert(`Maximum 4 documents allowed. You can upload ${4 - uploadedDocuments.length} more files.`);
            return;
        }

        const validFiles = files.filter(file => {
            const validExtensions = ['pdf', 'docx', 'txt'];
            const fileExtension = file.name.split('.').pop().toLowerCase();
            const maxSize = 50 * 1024 * 1024; // 50MB

            if (!validExtensions.includes(fileExtension)) {
                alert(`${file.name} is not a supported file type. Please upload PDF, DOCX, or TXT files.`);
                return false;
            }

            if (file.size > maxSize) {
                alert(`${file.name} is too large. Please upload files smaller than 50MB.`);
                return false;
            }

            return true;
        });

        validFiles.forEach(file => {
            if (!uploadedDocuments.some(doc => doc.name === file.name && doc.size === file.size)) {
                uploadFile(file);
            } else {
                alert(`File "${file.name}" is already uploaded.`);
            }
        });
    }

    function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);

        // Show uploading state
        displayFile(file, true);

        // Add timeout for upload requests
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
            controller.abort();
            console.log('Upload request timed out after 30 seconds');
        }, 30000); // 30 second timeout

        fetch('/ai-tutor/upload-document', {
            method: 'POST',
            body: formData,
            signal: controller.signal
        })
        .then(response => {
            clearTimeout(timeoutId);
            return response.json().then(data => {
                if (!response.ok) {
                    // Server returned an error status with JSON error message
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                return data;
            });
        })
        .then(data => {
            clearTimeout(timeoutId);
            if (data.success) {
                // Update file display to show success
                updateFileStatus(file.name, 'success');
                // Reload documents from server to ensure sync
                loadUploadedDocuments();
                addMessage(`‚úÖ Document "${file.name}" has been uploaded and analyzed. You can now ask questions about its content!`, 'ai');
            } else {
                alert('Upload failed: ' + data.error + (data.debug ? '\nDebug: ' + data.debug : ''));
                removeFileDisplay(file.name);
            }
        })
        .catch(error => {
            clearTimeout(timeoutId);
            if (error.name === 'AbortError') {
                console.error('Upload timed out');
                alert('Upload timed out after 30 seconds. Please try again.');
            } else {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message + '. Please try again.');
            }
            removeFileDisplay(file.name);
            // Remove from uploadedDocuments if it was added during duplicate check
            uploadedDocuments = uploadedDocuments.filter(doc => !(doc.name === file.name && doc.size === file.size));
            updateFileCount();
        });
    }

    function createSafeId(filename) {
        // Replace special characters with safe alternatives for CSS selectors
        return filename.replace(/[^a-zA-Z0-9\-_]/g, '_');
    }

    function displayFile(file, isUploading = false) {
        const safeId = createSafeId(file.name);
        const fileItem = document.createElement('div');
        fileItem.className = `file-item ${isUploading ? 'uploading' : ''}`;
        fileItem.id = `file-${safeId}`;
        fileItem.innerHTML = `
            <div class="file-name">
                ${isUploading ? '<i class="fas fa-spinner fa-spin me-2"></i>' : '<i class="fas fa-file me-2"></i>'}
                <span>${file.name}</span>
            </div>
            <div class="file-meta">
                <div class="file-size">${formatFileSize(file.size)}</div>
                ${isUploading ? '<div class="upload-progress"><div class="progress-bar"></div></div>' : ''}
                <button class="remove-file" onclick="removeFile('${file.name.replace(/'/g, "\\'")}')" ${isUploading ? 'disabled' : ''}>
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        uploadedFiles.appendChild(fileItem);
        if (isUploading) {
            animateProgress(file.name);
        }
    }

    function animateProgress(fileName) {
        const safeId = createSafeId(fileName);
        const progressBar = document.querySelector(`#file-${safeId} .progress-bar`);
        if (progressBar) {
            progressBar.style.width = '0%';
            setTimeout(() => {
                progressBar.style.transition = 'width 2s ease';
                progressBar.style.width = '100%';
            }, 100);
        }
    }

    function updateFileStatus(fileName, status) {
        const safeId = createSafeId(fileName);
        const fileItem = document.getElementById(`file-${safeId}`);
        if (fileItem) {
            fileItem.classList.remove('uploading');
            const nameDiv = fileItem.querySelector('.file-name');
            const progressBar = fileItem.querySelector('.upload-progress');
            const removeBtn = fileItem.querySelector('.remove-file');

            if (status === 'success') {
                nameDiv.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i><span>' + fileName + '</span>';
                if (progressBar) progressBar.remove();
                if (removeBtn) removeBtn.disabled = false;
            }
        }
    }

    function removeFileDisplay(fileName) {
        const safeId = createSafeId(fileName);
        const fileItem = document.getElementById(`file-${safeId}`);
        if (fileItem) {
            fileItem.remove();
        }
    }

    function displayExistingFile(doc) {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item success';
        fileItem.innerHTML = `
            <div class="file-name">
                <i class="fas fa-check-circle text-success me-2"></i>
                <span>${doc.filename}</span>
            </div>
            <div class="file-meta">
                <div class="file-size">Uploaded</div>
                <button class="remove-file" onclick="removeFile('${doc.filename}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        uploadedFiles.appendChild(fileItem);
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    window.removeFile = function(fileName) {
        // Call backend to remove from session
        fetch(`/ai-tutor/remove-document/${encodeURIComponent(fileName)}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                uploadedDocuments = uploadedDocuments.filter(file => file.name !== fileName);
                const fileItems = uploadedFiles.querySelectorAll('.file-item');
                fileItems.forEach(item => {
                    if (item.querySelector('.file-name').textContent.trim() === fileName) {
                        item.remove();
                    }
                });
                updateFileCount();
            } else {
                alert('Failed to remove document. Please try again.');
            }
        })
        .catch(error => {
            console.error('Remove error:', error);
            alert('Failed to remove document. Please try again.');
        });
    };

    function updateFileCount() {
        const fileCount = document.getElementById('fileCount');
        if (fileCount) {
            fileCount.textContent = uploadedDocuments.length;
        }
    }

    // Initialize speech features
    initSpeechRecognition();
    initSpeechSynthesis();

    // Make voice functions globally available
    window.startVoiceInput = startVoiceInput;
    window.addMessage = addMessage;
    window.addQuickMessage = addQuickMessage;

    // Load saved preferences
    const savedLanguage = localStorage.getItem('ai_tutor_language');
    if (savedLanguage && translations[savedLanguage]) {
        currentLanguage = savedLanguage;
        document.getElementById('languageSelect').value = savedLanguage;
        updateLanguage();
    }


    // Load existing documents
    loadUploadedDocuments();

    // Attach TTS handlers to existing message buttons
    attachTTSHandlers();

    // Focus input on load
    chatInput.focus();

    // Send message on Enter (but not Shift+Enter)
    chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Send message on button click
    sendButton.addEventListener('click', sendMessage);

    // Scroll to bottom on load
    scrollToBottom();

    // Handle scroll to show/hide scroll to bottom button
    chatMessages.addEventListener('scroll', function() {
        const scrollButton = document.getElementById('scrollToBottom');
        const isNearBottom = chatMessages.scrollTop + chatMessages.clientHeight >= chatMessages.scrollHeight - 100;

        if (isNearBottom) {
            scrollButton.style.display = 'none';
        } else {
            scrollButton.style.display = 'flex';
        }
    });

    function sendMessage() {
        const message = chatInput.value.trim();

        if (!message || isTyping) return;

        // Add user message to chat
        addMessage(message, 'user');
        chatInput.value = '';

        // Show typing indicator
        showTypingIndicator();

        // Send to server with timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

        fetch('/ai-tutor/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `message=${encodeURIComponent(message)}&language=${encodeURIComponent(currentLanguage)}`,
            signal: controller.signal
        })
        .then(response => {
            clearTimeout(timeoutId);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            hideTypingIndicator();
            if (data.error) {
                const errorMsg = 'Sorry, I encountered an error. Please try again.';
                addMessage(errorMsg, 'ai');
                speakText(errorMsg);
            } else {
                const cleanedResponse = cleanAIResponse(data.response);
                addMessage(cleanedResponse, 'ai');
            }
        })
        .catch(error => {
            clearTimeout(timeoutId);
            hideTypingIndicator();
            if (error.name === 'AbortError') {
                addMessage('‚ö° Taking longer than expected. Here\'s a quick study tip: Use the Pomodoro technique - 25 minutes of focused study followed by a 5-minute break!', 'ai');
            } else {
                addMessage('üåê Connection issue detected. Please try again. Remember: consistent study habits lead to better results!', 'ai');
            }
            console.error('Error:', error);
        });
    }

    function addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;

        const avatarDiv = document.createElement('div');
        avatarDiv.className = sender === 'user' ? 'message-avatar' : 'message-avatar ai-avatar';
        avatarDiv.innerHTML = sender === 'user' ?
            '<i class="fas fa-user"></i>' :
            '<i class="fas fa-robot"></i>';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';

        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = `message-bubble ${sender}-bubble`;

        const textDiv = document.createElement('div');
        if (sender === 'user') {
            textDiv.className = 'message-text user-text';
            textDiv.style.color = '#000000';
            textDiv.style.fontWeight = '500';
        } else {
            textDiv.className = 'message-text ai-response';
        }
        textDiv.innerHTML = text.replace(/\n/g, '<br>');

        const timeDiv = document.createElement('div');
        if (sender === 'user') {
            timeDiv.className = 'message-time user-time';
            timeDiv.style.color = 'rgba(0, 0, 0, 0.6)';
        } else {
            timeDiv.className = 'message-time ai-time';
        }
        timeDiv.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        bubbleDiv.appendChild(textDiv);
        bubbleDiv.appendChild(timeDiv);

        // Add TTS button for AI messages
        if (sender === 'ai') {
            const speakButton = document.createElement('button');
            speakButton.className = 'message-speak-btn';
            speakButton.innerHTML = '<i class="fas fa-play"></i>';
            speakButton.title = 'Speak this message';
            speakButton.onclick = function() {
                if (synthesis && synthesis.speaking) {
                    // If currently speaking, stop it
                    stopTTS();
                    speakButton.innerHTML = '<i class="fas fa-play"></i>';
                    speakButton.title = 'Speak this message';
                    speakButton.classList.remove('speaking');
                } else {
                    // Start speaking
                    speakText(text, messageDiv);
                    speakButton.innerHTML = '<i class="fas fa-stop"></i>';
                    speakButton.title = 'Stop speaking';
                    speakButton.classList.add('speaking');
                }
            };
            bubbleDiv.appendChild(speakButton);
        }

        contentDiv.appendChild(bubbleDiv);

        if (sender === 'user') {
            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(avatarDiv);
        } else {
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
        }

        chatMessages.appendChild(messageDiv);
        scrollToBottom();

        // Hide scroll button since we're at bottom after adding message
        const scrollButton = document.getElementById('scrollToBottom');
        scrollButton.style.display = 'none';

        // Animate message appearance
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = sender === 'user' ? 'translateX(20px)' : 'translateX(-20px)';
        setTimeout(() => {
            messageDiv.style.transition = 'all 0.3s ease';
            messageDiv.style.opacity = '1';
            messageDiv.style.transform = 'translateX(0)';
        }, 10);
    }

    function showTypingIndicator() {
        isTyping = true;
        typingIndicator.style.display = 'block';
        scrollToBottom();
    }

    function hideTypingIndicator() {
        isTyping = false;
        typingIndicator.style.display = 'none';
        // Scroll to bottom after hiding typing indicator
        scrollToBottom();
    }

    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
        // Hide scroll button when at bottom
        setTimeout(() => {
            const scrollButton = document.getElementById('scrollToBottom');
            scrollButton.style.display = 'none';
        }, 100);
    }

    // Make scrollToBottom globally available
    window.scrollToBottom = scrollToBottom;
});

// Feature functions
function useExample(example) {
    document.getElementById('chatInput').value = example;
    document.getElementById('sendButton').click();
}

function getStudyTip() {
    fetch('/ai-tutor/study-tip')
        .then(response => response.json())
        .then(data => {
            addQuickMessage(`üí° ${data.tip}`, 'ai');
        })
        .catch(error => {
            console.error('Error getting study tip:', error);
        });
}

function suggestTopics() {
    fetch('/ai-tutor/suggest-topics')
        .then(response => response.json())
        .then(data => {
            const topicsText = `Based on your goals and recent tasks, here are some suggested study topics:\n\n${data.topics.map(topic => `‚Ä¢ ${topic}`).join('\n')}`;
            addQuickMessage(topicsText, 'ai');
        })
        .catch(error => {
            console.error('Error getting topic suggestions:', error);
        });
}

function clearHistory() {
    if (confirm('Are you sure you want to clear your chat history? This cannot be undone.')) {
        fetch('/ai-tutor/clear-history', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        }).then(() => {
            location.reload();
        });
    }
}

function addQuickMessage(text, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;

    const avatarDiv = document.createElement('div');
    avatarDiv.className = 'message-avatar ai-avatar';
    avatarDiv.innerHTML = '<i class="fas fa-robot"></i>';

    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';

    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = 'message-bubble ai-bubble';

    const textDiv = document.createElement('div');
    textDiv.className = 'message-text ai-response';
    textDiv.innerHTML = text.replace(/\n/g, '<br>');

    bubbleDiv.appendChild(textDiv);

    // Add TTS button for AI quick messages
    if (sender === 'ai') {
        const speakButton = document.createElement('button');
        speakButton.className = 'message-speak-btn';
        speakButton.innerHTML = '<i class="fas fa-play"></i>';
        speakButton.title = 'Speak this message';
        speakButton.onclick = function() {
            if (synthesis && synthesis.speaking) {
                // If currently speaking, stop it
                stopTTS();
                speakButton.innerHTML = '<i class="fas fa-play"></i>';
                speakButton.title = 'Speak this message';
                speakButton.classList.remove('speaking');
            } else {
                // Start speaking
                speakText(text, messageDiv);
                speakButton.innerHTML = '<i class="fas fa-stop"></i>';
                speakButton.title = 'Stop speaking';
                speakButton.classList.add('speaking');
            }
        };
        bubbleDiv.appendChild(speakButton);
    }

    contentDiv.appendChild(bubbleDiv);
    messageDiv.appendChild(avatarDiv);
    messageDiv.appendChild(contentDiv);

    document.getElementById('chatMessages').appendChild(messageDiv);
    scrollToBottom();
}

// Quiz functionality
let currentQuiz = null;
let currentAttempt = null;
let currentQuestionIndex = 0;
let quizAnswers = [];
let quizStartTime = null;

function openQuizModal() {
    const modal = new bootstrap.Modal(document.getElementById('quizModal'));
    resetQuizModal();
    modal.show();
}

function resetQuizModal() {
    document.getElementById('quizForm').style.display = 'block';
    document.getElementById('quizInterface').style.display = 'none';
    document.getElementById('quizResults').style.display = 'none';
    document.getElementById('quizLoading').style.display = 'none';
}

function generateQuiz() {
    const topic = document.getElementById('quizTopic').value.trim();
    const subject = document.getElementById('quizSubject').value.trim();
    const difficulty = document.getElementById('quizDifficulty').value;
    const questionCount = document.getElementById('quizQuestions').value;
    const sourceType = document.querySelector('input[name="quizSource"]:checked').value;

    // Collect selected question types
    const selectedTypes = [];
    const checkboxes = ['multipleChoice', 'trueFalse', 'shortAnswer', 'fillBlank'];
    checkboxes.forEach(type => {
        const checkbox = document.getElementById(type);
        if (checkbox && checkbox.checked) {
            selectedTypes.push(checkbox.value);
        }
    });

    if (!topic) {
        alert('Please enter a topic for the quiz.');
        return;
    }

    if (selectedTypes.length === 0) {
        alert('Please select at least one question type.');
        return;
    }

    // Show loading
    document.getElementById('quizForm').style.display = 'none';
    document.getElementById('quizLoading').style.display = 'block';

    // Make API call to generate quiz
    fetch('/ai-tutor/generate-quiz', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            topic: topic,
            subject: subject,
            difficulty: difficulty,
            question_count: questionCount,
            source_type: sourceType,
            question_types: selectedTypes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentQuiz = data;
            startQuizAttempt();
        } else {
            alert('Failed to generate quiz: ' + data.error);
            resetQuizModal();
        }
    })
    .catch(error => {
        console.error('Error generating quiz:', error);
        alert('Failed to generate quiz. Please try again.');
        resetQuizModal();
    });
}

function startQuizAttempt() {
    fetch(`/ai-tutor/quiz/${currentQuiz.quiz_id}/attempt`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.attempt_id) {
            currentAttempt = data;
            quizAnswers = [];
            currentQuestionIndex = 0;
            quizStartTime = new Date();

            // Load quiz questions
            loadQuizQuestions();
        } else {
            alert('Failed to start quiz attempt.');
            resetQuizModal();
        }
    })
    .catch(error => {
        console.error('Error starting quiz attempt:', error);
        alert('Failed to start quiz attempt.');
        resetQuizModal();
    });
}

function loadQuizQuestions() {
    fetch(`/ai-tutor/quiz/${currentQuiz.quiz_id}`)
    .then(response => response.json())
    .then(data => {
        if (data.questions) {
            currentQuiz.questions = data.questions;
            document.getElementById('quizLoading').style.display = 'none';
            document.getElementById('quizInterface').style.display = 'block';

            document.getElementById('quizTitle').textContent = data.title;
            document.getElementById('totalQuestions').textContent = data.questions.length;
            updateQuizProgress();
            showQuestion(0);
        } else {
            alert('Failed to load quiz questions.');
            resetQuizModal();
        }
    })
    .catch(error => {
        console.error('Error loading quiz questions:', error);
        alert('Failed to load quiz questions.');
        resetQuizModal();
    });
}

function showQuestion(index) {
    const question = currentQuiz.questions[index];
    const container = document.getElementById('questionContainer');

    let html = `
        <div class="question-card">
            <h5 class="question-text">${question.question_text}</h5>
            <div class="options mt-3">
    `;

    if (question.question_type === 'multiple_choice' && question.options) {
        question.options.forEach((option, i) => {
            const optionLetter = String.fromCharCode(65 + i); // A, B, C, D
            html += `
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question${index}" id="option${i}" value="${optionLetter}">
                    <label class="form-check-label" for="option${i}">
                        ${option}
                    </label>
                </div>
            `;
        });
    } else if (question.question_type === 'true_false') {
        html += `
            <div class="form-check">
                <input class="form-check-input" type="radio" name="question${index}" id="true" value="true">
                <label class="form-check-label" for="true">True</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="question${index}" id="false" value="false">
                <label class="form-check-label" for="false">False</label>
            </div>
        `;
    } else {
        html += `
            <textarea class="form-control" id="shortAnswer" rows="3" placeholder="Enter your answer here..."></textarea>
        `;
    }

    html += `
            </div>
        </div>
    `;

    container.innerHTML = html;

    // Restore previous answer if any
    if (quizAnswers[index]) {
        const answer = quizAnswers[index];
        if (question.question_type === 'short_answer' || question.question_type === 'fill_blank') {
            document.getElementById('shortAnswer').value = answer.user_answer || '';
        } else {
            const radio = document.querySelector(`input[name="question${index}"][value="${answer.user_answer}"]`);
            if (radio) radio.checked = true;
        }
    }


    updateNavigationButtons();
}

function updateQuizProgress() {
    const progress = ((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100;
    document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
    document.getElementById('quizProgressBar').style.width = progress + '%';
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevQuestion');
    const nextBtn = document.getElementById('nextQuestion');
    const finishBtn = document.getElementById('finishQuiz');

    prevBtn.disabled = currentQuestionIndex === 0;

    if (currentQuestionIndex === currentQuiz.questions.length - 1) {
        nextBtn.style.display = 'none';
        finishBtn.style.display = 'inline-block';
    } else {
        nextBtn.style.display = 'inline-block';
        finishBtn.style.display = 'none';
    }
}

function nextQuestion() {
    saveCurrentAnswer();
    if (currentQuestionIndex < currentQuiz.questions.length - 1) {
        currentQuestionIndex++;
        updateQuizProgress();
        showQuestion(currentQuestionIndex);
    }
}

function prevQuestion() {
    saveCurrentAnswer();
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        updateQuizProgress();
        showQuestion(currentQuestionIndex);
    }
}

function saveCurrentAnswer() {
    const question = currentQuiz.questions[currentQuestionIndex];
    let userAnswer = '';

    if (question.question_type === 'short_answer' || question.question_type === 'fill_blank' || question.question_type === 'essay') {
        userAnswer = document.getElementById('shortAnswer').value.trim();
    } else {
        const selected = document.querySelector(`input[name="question${currentQuestionIndex}"]:checked`);
        userAnswer = selected ? selected.value : '';
    }

    quizAnswers[currentQuestionIndex] = {
        question_id: question.id,
        user_answer: userAnswer,
        time_taken: 0 // Could implement timing per question
    };
}

function finishQuiz() {
    saveCurrentAnswer();

    // Submit all answers
    const submissionPromises = quizAnswers.map((answer, index) => {
        if (!answer.user_answer) return Promise.resolve(); // Skip unanswered questions

        return fetch('/ai-tutor/quiz/attempt/' + currentAttempt.attempt_id + '/answer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                question_id: answer.question_id,
                answer: answer.user_answer
            })
        });
    });

    Promise.all(submissionPromises)
    .then(() => {
        // Complete the quiz attempt
        return fetch('/ai-tutor/quiz/attempt/' + currentAttempt.attempt_id + '/complete', {
            method: 'POST'
        });
    })
    .then(response => response.json())
    .then(data => {
        showQuizResults(data);
    })
    .catch(error => {
        console.error('Error finishing quiz:', error);
        alert('Failed to complete quiz. Please try again.');
    });
}

function showQuizResults(data) {
    document.getElementById('quizInterface').style.display = 'none';
    document.getElementById('quizResults').style.display = 'block';

    document.getElementById('finalScore').textContent = data.percentage + '%';
    document.getElementById('correctAnswers').textContent = Math.round((data.score / data.max_score) * currentQuiz.questions.length);
    document.getElementById('totalQuestionsResult').textContent = currentQuiz.questions.length;
    document.getElementById('timeTaken').textContent = formatTime(data.time_taken);

    // Add detailed results showing each question with correct answers
    addDetailedResults();
}

function addDetailedResults() {
    const resultsContainer = document.getElementById('quizResults');

    // Create detailed results section
    let detailedHtml = `
        <div class="detailed-results mt-4">
            <h5 class="mb-3 text-center">üìä Question Review</h5>
    `;

    currentQuiz.questions.forEach((question, index) => {
        const userAnswerData = quizAnswers[index];
        const userAnswer = userAnswerData ? userAnswerData.user_answer : 'Not answered';

        // Get full answer text for multiple choice
        let userAnswerDisplay = userAnswer || 'Not answered';
        let correctAnswerDisplay = question.correct_answer;

        if (question.question_type === 'multiple_choice' && question.options && userAnswer) {
            // Find the full option text for user's answer
            const userOption = question.options.find(opt => opt.startsWith(userAnswer + ')'));
            if (userOption) userAnswerDisplay = userOption;
        }

        if (question.question_type === 'multiple_choice' && question.options) {
            // Find the full option text for correct answer
            const correctOption = question.options.find(opt => opt.startsWith(question.correct_answer + ')'));
            if (correctOption) correctAnswerDisplay = correctOption;
        }

        const isCorrect = userAnswer && (
            (question.question_type === 'multiple_choice' || question.question_type === 'true_false') ?
                userAnswer === question.correct_answer :
                userAnswer.toLowerCase().trim() === question.correct_answer.toLowerCase().trim()
        );

        detailedHtml += `
            <div class="question-review-card mb-2 p-2 border rounded ${isCorrect ? 'border-success bg-success bg-opacity-10' : 'border-danger bg-danger bg-opacity-10'}">
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <small class="text-muted fw-bold">Q${index + 1}</small>
                    <small class="${isCorrect ? 'text-success' : 'text-danger'} fw-bold">
                        <i class="fas ${isCorrect ? 'fa-check-circle' : 'fa-times-circle'} me-1"></i>
                        ${isCorrect ? 'Correct' : 'Incorrect'}
                    </small>
                </div>

                <p class="mb-2 small">${question.question_text}</p>

                <div class="answer-comparison">
                    <div class="mb-1">
                        <span class="badge ${isCorrect ? 'bg-success' : 'bg-danger'} me-2">Your Answer</span>
                        <span class="small ${isCorrect ? 'text-success fw-bold' : 'text-danger fw-bold'}">${userAnswerDisplay}</span>
                    </div>

                    ${!isCorrect ? `
                    <div class="mb-1">
                        <span class="badge bg-primary me-2">Correct Answer</span>
                        <span class="small text-primary fw-bold">${correctAnswerDisplay}</span>
                    </div>
                    ` : ''}

                    ${question.explanation ? `<div class="mt-1"><small class="text-muted"><i class="fas fa-info-circle me-1"></i>${question.explanation}</small></div>` : ''}
                </div>
            </div>
        `;
    });

    detailedHtml += `</div>`;

    // Insert before the retake button
    const retakeBtn = resultsContainer.querySelector('button[onclick="retakeQuiz()"]');
    if (retakeBtn) {
        retakeBtn.insertAdjacentHTML('beforebegin', detailedHtml);
    } else {
        resultsContainer.innerHTML += detailedHtml;
    }
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
}

function retakeQuiz() {
    resetQuizModal();
}

function downloadQuestions() {
    if (!currentQuiz || !currentQuiz.questions) {
        alert('No quiz questions available to download.');
        return;
    }

    let content = `<html><head><title>${currentQuiz.title || 'Quiz'} - Questions</title></head><body>`;
    content += `<h1>${currentQuiz.title || 'Quiz'} - Questions</h1>`;
    content += `<p><strong>Subject:</strong> ${currentQuiz.subject && currentQuiz.subject.trim() ? currentQuiz.subject : 'N/A'}</p>`;
    content += `<p><strong>Difficulty:</strong> ${currentQuiz.difficulty || 'N/A'}</p>`;
    content += `<p><strong>Generated:</strong> ${new Date().toLocaleDateString()}</p>`;
    content += `<hr>`;

    currentQuiz.questions.forEach((question, index) => {
        content += `<h3>Question ${index + 1}: ${question.question_text}</h3>`;

        if (question.question_type === 'multiple_choice' && question.options) {
            question.options.forEach((option, i) => {
                content += `<p>${option}</p>`;
            });
        } else if (question.question_type === 'true_false') {
            content += `<p>True</p><p>False</p>`;
        } else {
            content += `<p>________________________________________________________________________________</p>`;
            content += `<p>________________________________________________________________________________</p>`;
            content += `<p>________________________________________________________________________________</p>`;
        }

        content += `<br>`;
    });

    content += `</body></html>`;

    downloadFile(content, `${currentQuiz.title || 'quiz'}_questions.doc`, 'application/msword');
}

function downloadAnswers() {
    if (!currentQuiz || !currentQuiz.questions) {
        alert('No quiz answers available to download.');
        return;
    }

    let content = `<html><head><title>${currentQuiz.title || 'Quiz'} - Answers</title></head><body>`;
    content += `<h1>${currentQuiz.title || 'Quiz'} - Answer Key</h1>`;
    content += `<p><strong>Subject:</strong> ${currentQuiz.subject && currentQuiz.subject.trim() ? currentQuiz.subject : 'N/A'}</p>`;
    content += `<p><strong>Difficulty:</strong> ${currentQuiz.difficulty || 'N/A'}</p>`;
    content += `<p><strong>Generated:</strong> ${new Date().toLocaleDateString()}</p>`;
    content += `<hr>`;

    currentQuiz.questions.forEach((question, index) => {
        content += `<h3>Question ${index + 1}: ${question.question_text}</h3>`;
        content += `<p><strong>Correct Answer:</strong> ${question.correct_answer}</p>`;

        if (question.explanation) {
            content += `<p><strong>Explanation:</strong> ${question.explanation}</p>`;
        }

        content += `<br>`;
    });

    content += `</body></html>`;

    downloadFile(content, `${currentQuiz.title || 'quiz'}_answers.doc`, 'application/msword');
}

function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    URL.revokeObjectURL(url);
}
</script>
{% endblock %}