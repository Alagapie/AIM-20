{% extends "base.html" %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.insights-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.metric-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    border: none;
    text-align: center;
}

.metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    margin: 0.5rem 0;
}

.metric-label {
    color: #6c757d;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.chart-container {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.chart-header {
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 1rem;
    margin-bottom: 1rem;
}

.burnout-alert {
    background: linear-gradient(135deg, #ff6b6b, #ee5a52);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 1.5rem;
}

.trend-indicator {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.trend-up { background: #d4edda; color: #155724; }
.trend-down { background: #f8d7da; color: #721c24; }
.trend-stable { background: #fff3cd; color: #856404; }

.loading-spinner {
    display: none;
    justify-content: center;
    align-items: center;
    min-height: 300px;
}

.spinner-border-sm {
    width: 2rem;
    height: 2rem;
}

.no-data-message {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
}

.no-data-message i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Professional Header -->
    <div class="insights-header">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="h2 mb-2">Productivity Analytics Dashboard</h1>
                <p class="mb-0 opacity-75">Comprehensive insights into your study patterns, performance metrics, and optimization opportunities</p>
            </div>
            <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                <div class="d-flex gap-2 justify-content-lg-end">
                    <a href="{{ url_for('insights.recommendations') }}" class="btn btn-light btn-lg">
                        <i class="fas fa-lightbulb me-2"></i>AI Recommendations
                    </a>
                    <a href="{{ url_for('insights.burnout_prediction') }}" class="btn btn-warning btn-lg">
                        <i class="fas fa-heartbeat me-2"></i>Burnout Monitor
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Professional Key Metrics Cards -->
    <div class="row mb-4">
        <div class="col-xl-2 col-lg-4 col-md-6 mb-4">
            <div class="metric-card">
                <div class="text-primary mb-2">
                    <i class="fas fa-clock fa-2x"></i>
                </div>
                <div class="metric-value text-primary">{{ "%.1f"|format(insights.total_hours or 0) }}</div>
                <div class="metric-label">Study Hours</div>
                <small class="text-muted">Last 30 days</small>
            </div>
        </div>
        <div class="col-xl-2 col-lg-4 col-md-6 mb-4">
            <div class="metric-card">
                <div class="text-success mb-2">
                    <i class="fas fa-check-circle fa-2x"></i>
                </div>
                <div class="metric-value text-success">{{ insights.total_tasks or 0 }}</div>
                <div class="metric-label">Tasks Completed</div>
                <small class="text-muted">All time</small>
            </div>
        </div>
        <div class="col-xl-2 col-lg-4 col-md-6 mb-4">
            <div class="metric-card">
                <div class="text-info mb-2">
                    <i class="fas fa-bullseye fa-2x"></i>
                </div>
                <div class="metric-value text-info">{{ insights.total_goals or 0 }}</div>
                <div class="metric-label">Goals Progressed</div>
                <small class="text-muted">This month</small>
            </div>
        </div>
        <div class="col-xl-2 col-lg-4 col-md-6 mb-4">
            <div class="metric-card">
                <div class="text-warning mb-2">
                    <i class="fas fa-chart-line fa-2x"></i>
                </div>
                <div class="metric-value text-warning">{{ "%.1f"|format(insights.avg_productivity or 0) }}</div>
                <div class="metric-label">Productivity Score</div>
                <small class="text-muted">Average</small>
            </div>
        </div>
        <div class="col-xl-2 col-lg-4 col-md-6 mb-4">
            <div class="metric-card">
                <div class="text-danger mb-2">
                    <i class="fas fa-fire fa-2x"></i>
                </div>
                <div class="metric-value text-danger">{{ insights.current_streak or 0 }}</div>
                <div class="metric-label">Current Streak</div>
                <small class="text-muted">Days active</small>
            </div>
        </div>
        <div class="col-xl-2 col-lg-4 col-md-6 mb-4">
            <div class="metric-card">
                <div class="text-secondary mb-2">
                    <i class="fas fa-crosshairs fa-2x"></i>
                </div>
                <div class="metric-value text-secondary">{{ "%.1f"|format(insights.avg_focus or 0) }}</div>
                <div class="metric-label">Focus Score</div>
                <small class="text-muted">Average</small>
            </div>
        </div>
    </div>

    <!-- Professional Charts Section -->
    <div class="row mb-4">
        <div class="col-lg-8 mb-4">
            <div class="chart-container">
                <div class="chart-header">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2 text-primary"></i>Productivity Trends Overview</h5>
                    <small class="text-muted">Last 30 days performance analysis</small>
                </div>
                <div class="loading-spinner" id="productivityLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading chart...</span>
                    </div>
                </div>
                <div id="productivityChartContainer" style="display: none;">
                    <canvas id="productivityChart" height="350"></canvas>
                </div>
                <div id="noDataMessage" class="no-data-message" style="display: none;">
                    <i class="fas fa-chart-bar"></i>
                    <h5>Not enough data</h5>
                    <p>Start using the app to see your productivity trends here.</p>
                </div>
            </div>
        </div>
        <div class="col-lg-4 mb-4">
            <div class="chart-container">
                <div class="chart-header">
                    <h5 class="mb-0"><i class="fas fa-calendar-week me-2 text-success"></i>Weekly Performance</h5>
                    <small class="text-muted">Current week summary</small>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-semibold">Study Hours</span>
                            <span class="badge bg-primary">{{ "%.1f"|format(insights.week_hours or 0) }}</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" style="width: {{ ((insights.week_hours or 0) / 40) * 100 }}%"></div>
                        </div>
                        <small class="text-muted">Target: 40 hours/week</small>
                    </div>

                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-semibold">Tasks Completed</span>
                            <span class="badge bg-success">{{ insights.week_tasks or 0 }}</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: {{ ((insights.week_tasks or 0) / 20) * 100 }}%"></div>
                        </div>
                        <small class="text-muted">Target: 20 tasks/week</small>
                    </div>

                    {% if insights.productivity_trend %}
                    <div class="mb-3">
                        <strong>Performance Trend:</strong>
                        {% if insights.productivity_trend == 'up' %}
                        <span class="trend-indicator trend-up"><i class="fas fa-arrow-up me-1"></i>Improving</span>
                        {% elif insights.productivity_trend == 'down' %}
                        <span class="trend-indicator trend-down"><i class="fas fa-arrow-down me-1"></i>Declining</span>
                        {% else %}
                        <span class="trend-indicator trend-stable"><i class="fas fa-equals me-1"></i>Stable</span>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if insights.best_day %}
                    <div class="mb-0">
                        <strong class="text-muted">Best Performance:</strong>
                        <div class="small">{{ insights.best_day.date }}</div>
                        <div class="small text-primary fw-semibold">{{ insights.best_day.score }} productivity score</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Professional Burnout Risk Alert -->
    {% if insights.avg_burnout is defined and insights.avg_burnout >= 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="burnout-alert" id="burnoutAlert">
                <div class="d-flex align-items-center">
                    <div class="me-4">
                        {% if insights.avg_burnout >= 60 %}
                        <i class="fas fa-exclamation-triangle fa-4x"></i>
                        {% elif insights.avg_burnout >= 30 %}
                        <i class="fas fa-exclamation-circle fa-4x"></i>
                        {% else %}
                        <i class="fas fa-check-circle fa-4x"></i>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h4 class="mb-1">Wellness Monitor</h4>
                            <span class="badge fs-6 px-3 py-2
                                {% if insights.avg_burnout >= 60 %}bg-danger
                                {% elif insights.avg_burnout >= 30 %}bg-warning text-dark
                                {% else %}bg-success{% endif %}">
                                {{ "%.1f"|format(insights.avg_burnout) }}% Risk
                            </span>
                        </div>
                        <p class="mb-3 fs-5">
                            {% if insights.avg_burnout >= 60 %}
                            <strong>High Burnout Risk Detected</strong><br>
                            Your current patterns suggest elevated stress levels. Immediate action recommended.
                            {% elif insights.avg_burnout >= 30 %}
                            <strong>Moderate Burnout Risk</strong><br>
                            Consider implementing better work-life balance practices.
                            {% else %}
                            <strong>Healthy Balance Maintained</strong><br>
                            Your wellness indicators are in the optimal range.
                            {% endif %}
                        </p>
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('insights.burnout_prediction') }}" class="btn btn-light">
                                <i class="fas fa-chart-bar me-2"></i>View Details
                            </a>
                            {% if insights.avg_burnout >= 30 %}
                            <a href="{{ url_for('insights.recommendations') }}" class="btn btn-outline-light">
                                <i class="fas fa-lightbulb me-2"></i>Get Help
                            </a>
                            {% endif %}
                            <button type="button" class="btn btn-outline-light" onclick="dismissBurnoutAlert()">
                                <i class="fas fa-times me-1"></i>Dismiss
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Professional Secondary Charts -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <div class="chart-header">
                    <h5 class="mb-0"><i class="fas fa-crosshairs me-2 text-warning"></i>Focus Score Trends</h5>
                    <small class="text-muted">Concentration levels over time</small>
                </div>
                <div class="loading-spinner" id="focusLoading">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Loading focus chart...</span>
                    </div>
                </div>
                <div id="focusChartContainer" style="display: none;">
                    <canvas id="focusChart" height="250"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <div class="chart-header">
                    <h5 class="mb-0"><i class="fas fa-heartbeat me-2 text-danger"></i>Burnout Risk Over Time</h5>
                    <small class="text-muted">Wellness monitoring trends</small>
                </div>
                <div class="loading-spinner" id="burnoutLoading">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Loading burnout chart...</span>
                    </div>
                </div>
                <div id="burnoutChartContainer" style="display: none;">
                    <canvas id="burnoutChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show loading states
    showLoadingStates();

    // Fetch productivity data
    fetch('/insights/api/productivity-data')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            hideLoadingStates();
            if (data.dates && data.dates.length > 0) {
                createProductivityChart(data);
                createFocusChart(data);
                createBurnoutChart(data);
                showCharts();
            } else {
                showNoDataMessage();
            }
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
            hideLoadingStates();
            showNoDataMessage();
        });
});

function showLoadingStates() {
    document.getElementById('productivityLoading').style.display = 'flex';
    document.getElementById('focusLoading').style.display = 'flex';
    document.getElementById('burnoutLoading').style.display = 'flex';
}

function hideLoadingStates() {
    document.getElementById('productivityLoading').style.display = 'none';
    document.getElementById('focusLoading').style.display = 'none';
    document.getElementById('burnoutLoading').style.display = 'none';
}

function showCharts() {
    document.getElementById('productivityChartContainer').style.display = 'block';
    document.getElementById('focusChartContainer').style.display = 'block';
    document.getElementById('burnoutChartContainer').style.display = 'block';
}

function showNoDataMessage() {
    document.getElementById('noDataMessage').style.display = 'block';
}

function dismissBurnoutAlert() {
    const alert = document.getElementById('burnoutAlert');
    if (alert) {
        alert.style.display = 'none';
    }
}

function createProductivityChart(data) {
    const ctx = document.getElementById('productivityChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Productivity Score',
                data: data.productivity_score,
                borderColor: 'rgb(13, 110, 253)',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Hours Studied',
                data: data.hours_studied,
                borderColor: 'rgb(25, 135, 84)',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                tension: 0.4,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Productivity Score'
                    }
                },
                y1: {
                    beginAtZero: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Hours Studied'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                }
            }
        }
    });
}

function createFocusChart(data) {
    const ctx = document.getElementById('focusChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Focus Score',
                data: data.focus_score,
                borderColor: 'rgb(255, 193, 7)',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

function createBurnoutChart(data) {
    const ctx = document.getElementById('burnoutChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Burnout Risk',
                data: data.burnout_risk,
                borderColor: 'rgb(220, 53, 69)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}
</script>
{% endblock %}