{% extends "base.html" %}

{% block head %}
<style>
.leaderboard-card {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
    transition: all 0.3s ease;
    border: none;
}

.leaderboard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.top-three {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    position: relative;
}

.podium {
    display: flex;
    justify-content: center;
    align-items: end;
    gap: 1rem;
    margin-bottom: 2rem;
}

.podium-position {
    text-align: center;
    min-width: 120px;
}

.podium-base {
    background: rgba(255,255,255,0.2);
    border-radius: 10px 10px 0 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
    transition: all 0.3s ease;
}

.podium-base:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-5px);
}

.podium-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #007bff;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.first-place { height: 140px; background: linear-gradient(135deg, #FFD700, #FFA500); }
.second-place { height: 120px; background: linear-gradient(135deg, #C0C0C0, #A8A8A8); }
.third-place { height: 100px; background: linear-gradient(135deg, #CD7F32, #A0522D); }

.leaderboard-rank {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 0.5rem 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    color: #495057;
    display: inline-block;
}

.rank-number {
    font-size: 1.2rem;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
}

.rank-1 { background: #FFD700; color: #333; }
.rank-2 { background: #C0C0C0; color: #333; }
.rank-3 { background: #CD7F32; color: #fff; }
.rank-other { background: #6c757d; color: white; }

.user-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #007bff;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    margin-right: 1rem;
}

.leaderboard-stats {
    display: flex;
    gap: 2rem;
    justify-content: center;
    margin-bottom: 2rem;
}

.stat-box {
    text-align: center;
    padding: 1rem;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    display: block;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.filter-section {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.filter-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
}

.filter-btn {
    background: white;
    border: 1px solid #dee2e6;
    color: #495057;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    transition: all 0.3s ease;
}

.filter-btn:hover,
.filter-btn.active {
    background: #007bff;
    border-color: #007bff;
    color: white;
}

.current-user-highlight {
    background: rgba(0, 123, 255, 0.1);
    border-left: 4px solid #007bff;
    animation: highlightPulse 2s ease-in-out;
}

@keyframes highlightPulse {
    0% { background: rgba(0, 123, 255, 0.1); }
    50% { background: rgba(0, 123, 255, 0.2); }
    100% { background: rgba(0, 123, 255, 0.1); }
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-0">üèÜ Leaderboard</h1>
                    <p class="text-muted mb-0">Compete with fellow learners and climb the ranks</p>
                </div>
                <a href="{{ url_for('gamification.index') }}" class="btn btn-outline-primary">
                    <i class="fas fa-home me-2"></i>Back to Hub
                </a>
            </div>
        </div>
    </div>

    <!-- Top Three Podium -->
    {% if leaderboard %}
    <div class="top-three">
        <div class="leaderboard-stats">
            <div class="stat-box">
                <span class="stat-value">{{ leaderboard|length }}</span>
                <span class="stat-label">Participants</span>
            </div>
            <div class="stat-box">
                <span class="stat-value">{{ leaderboard[0].total_points if leaderboard else 0 }}</span>
                <span class="stat-label">Top Score</span>
            </div>
            <div class="stat-box">
                <span class="stat-value">{{ "%.0f"|format(leaderboard[0].avg_productivity if leaderboard else 0) }}</span>
                <span class="stat-label">Avg Productivity</span>
            </div>
        </div>

        <div class="podium">
            {% if leaderboard|length > 1 %}
            <div class="podium-position">
                <div class="podium-base second-place">
                    <div class="podium-avatar">{{ leaderboard[1].username[:2].upper() }}</div>
                    <div class="text-center">
                        <h6 class="mb-1">{{ leaderboard[1].username }}</h6>
                        <small>{{ leaderboard[1].total_points }} XP</small>
                    </div>
                </div>
                <div class="leaderboard-rank">
                    <span class="rank-number rank-2">2</span>
                    2nd Place
                </div>
            </div>
            {% endif %}

            {% if leaderboard %}
            <div class="podium-position">
                <div class="podium-base first-place">
                    <div class="podium-avatar">üëë</div>
                    <div class="text-center">
                        <h5 class="mb-1">{{ leaderboard[0].username }}</h5>
                        <small>{{ leaderboard[0].total_points }} XP</small>
                    </div>
                </div>
                <div class="leaderboard-rank">
                    <span class="rank-number rank-1">1</span>
                    1st Place
                </div>
            </div>
            {% endif %}

            {% if leaderboard|length > 2 %}
            <div class="podium-position">
                <div class="podium-base third-place">
                    <div class="podium-avatar">{{ leaderboard[2].username[:2].upper() }}</div>
                    <div class="text-center">
                        <h6 class="mb-1">{{ leaderboard[2].username }}</h6>
                        <small>{{ leaderboard[2].total_points }} XP</small>
                    </div>
                </div>
                <div class="leaderboard-rank">
                    <span class="rank-number rank-3">3</span>
                    3rd Place
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Filters -->
    <div class="filter-section">
        <h5 class="text-center mb-3">Filter Rankings</h5>
        <div class="filter-buttons">
            <button type="button" class="btn filter-btn active" data-filter="all">All Time</button>
            <button type="button" class="btn filter-btn" data-filter="monthly">This Month</button>
            <button type="button" class="btn filter-btn" data-filter="weekly">This Week</button>
            <button type="button" class="btn filter-btn" data-filter="friends">Friends Only</button>
        </div>
    </div>

    <!-- Full Leaderboard -->
    <div class="leaderboard-card">
        <h4 class="mb-4">üìä Full Rankings</h4>
        {% if leaderboard %}
            <div class="list-group list-group-flush">
                {% for i, user in enumerate(leaderboard) %}
                <div class="list-group-item d-flex align-items-center {% if user.username == current_user.username %}current-user-highlight{% endif %}">
                    <div class="d-flex align-items-center flex-grow-1">
                        <div class="rank-number rank-{{ '1' if i == 0 else '2' if i == 1 else '3' if i == 2 else 'other' }}">
                            {{ i + 1 }}
                        </div>
                        <div class="user-avatar">
                            {{ user.username[:2].upper() }}
                        </div>
                        <div>
                            <h6 class="mb-0">{{ user.username }}{% if user.username == current_user.username %} <small class="text-primary">(You)</small>{% endif %}</h6>
                            <small class="text-muted">Level {{ user.level }} ‚Ä¢ {{ user.total_points }} XP</small>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="d-flex gap-3">
                            <div class="text-center">
                                <strong>{{ user.completed_tasks }}</strong><br>
                                <small class="text-muted">Tasks</small>
                            </div>
                            <div class="text-center">
                                <strong>{{ user.completed_goals }}</strong><br>
                                <small class="text-muted">Goals</small>
                            </div>
                            <div class="text-center">
                                <strong>{{ user.current_streak }}</strong><br>
                                <small class="text-muted">Streak</small>
                            </div>
                            <div class="text-center">
                                <strong>{{ "%.0f"|format(user.avg_productivity) }}</strong><br>
                                <small class="text-muted">Avg Prod</small>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-trophy"></i>
                <h5>No participants yet</h5>
                <p>Be the first to join the leaderboard! Start completing tasks and earning points.</p>
                <a href="{{ url_for('tasks.index') }}" class="btn btn-primary">
                    <i class="fas fa-play me-2"></i>Start Your Journey
                </a>
            </div>
        {% endif %}
    </div>

    <!-- Your Ranking Card -->
    {% if current_user_stats %}
    <div class="leaderboard-card">
        <h4 class="mb-4">üìç Your Current Ranking</h4>
        <div class="row">
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <div class="rank-number rank-{{ '1' if current_user_stats.rank == 1 else '2' if current_user_stats.rank == 2 else '3' if current_user_stats.rank == 3 else 'other' }} mb-3">
                            {{ current_user_stats.rank }}
                        </div>
                        <h5>Rank #{{ current_user_stats.rank }}</h5>
                        <p class="text-muted mb-0">Out of {{ leaderboard|length }} participants</p>
                        {% if current_user_stats.rank_change %}
                            {% if current_user_stats.rank_change > 0 %}
                                <p class="text-success mt-2">
                                    <i class="fas fa-arrow-up me-1"></i>
                                    ‚Üë{{ current_user_stats.rank_change }} positions this week
                                </p>
                            {% elif current_user_stats.rank_change < 0 %}
                                <p class="text-danger mt-2">
                                    <i class="fas fa-arrow-down me-1"></i>
                                    ‚Üì{{ current_user_stats.rank_change|abs }} positions this week
                                </p>
                            {% else %}
                                <p class="text-muted mt-2">
                                    <i class="fas fa-minus me-1"></i>
                                    No change this week
                                </p>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">Your Stats</h6>
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <div class="stat-value">{{ current_user_stats.total_points }}</div>
                                <div class="stat-label">Total XP</div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="stat-value">{{ current_user_stats.level }}</div>
                                <div class="stat-label">Level</div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="stat-value">{{ current_user_stats.current_streak }}</div>
                                <div class="stat-label">Current Streak</div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="stat-value">{{ current_user_stats.completed_tasks }}</div>
                                <div class="stat-label">Tasks Done</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Weekly Challenge -->
    <div class="leaderboard-card">
        <h4 class="mb-4">üéØ Weekly Challenge</h4>
        <div class="alert alert-info">
            <div class="d-flex align-items-center">
                <i class="fas fa-bullseye fa-2x me-3"></i>
                <div>
                    <h6 class="alert-heading mb-1">This Week's Challenge: Productivity Sprint</h6>
                    <p class="mb-2">Complete 20 tasks this week and earn a special "Sprint Master" badge!</p>
                    <div class="progress mb-2">
                        <div class="progress-bar bg-info" style="width: 0%"></div>
                    </div>
                    <small class="text-muted">0/20 tasks completed</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const filterButtons = document.querySelectorAll('.filter-btn');
    const leaderboardItems = document.querySelectorAll('.list-group-item');

    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');

            const filter = this.dataset.filter;

            // In a real implementation, this would fetch filtered data from the server
            // For now, we'll just show a message
            if (filter !== 'all') {
                console.log('Filtering by:', filter);
                // You would implement AJAX call here to fetch filtered leaderboard
            }
        });
    });

    // Animate current user highlight
    const currentUserItem = document.querySelector('.current-user-highlight');
    if (currentUserItem) {
        setTimeout(() => {
            currentUserItem.style.animation = 'highlightPulse 2s ease-in-out';
        }, 1000);
    }
});
</script>
{% endblock %}