{% extends "base.html" %}

{% block content %}
<!-- Hero Background -->
<div class="hero-section-modern min-vh-100 d-flex align-items-center">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-12">
                <!-- Header -->
                <div class="text-center mb-5">
                    <h1 class="hero-title mb-3">
                        <i class="fas fa-clock me-3"></i>
                        Pomodoro Timer
                    </h1>
                    <p class="hero-subtitle mb-4">
                        Focus on your tasks with timed work sessions and breaks
                    </p>
                    <a href="{{ url_for('pomodoro.statistics') }}" class="btn btn-light btn-lg px-4 py-3">
                        <i class="fas fa-chart-line me-2"></i>View Statistics
                    </a>
                </div>

                <!-- Main Content -->
                <div class="row justify-content-center">
                    <!-- Timer Section -->
                    <div class="col-lg-8">
                        <div class="card mb-4 border-0 shadow-lg">
                            <div class="card-header bg-transparent border-0">
                                <h5 class="card-title mb-0 text-center">
                                    <i class="fas fa-clock me-2 text-primary"></i>
                                    <span id="timer-title" class="fw-bold">Ready to Start</span>
                                </h5>
                            </div>
                            <div class="card-body text-center py-5">
                    <!-- Timer Display -->
                    <div class="timer-display mb-4">
                        <div class="timer-circle" id="timer-circle">
                            <div class="timer-text">
                                <div class="time-display" id="time-display">25:00</div>
                                <div class="session-info" id="session-info">Work Session</div>
                            </div>
                        </div>
                    </div>

                    <!-- Timer Controls -->
                    <div class="timer-controls mb-4">
                        <button class="btn btn-success btn-lg me-2" id="start-btn" onclick="startTimer()">
                            <i class="fas fa-play me-1"></i>Start
                        </button>
                        <button class="btn btn-warning btn-lg me-2" id="pause-btn" onclick="pauseTimer()" disabled>
                            <i class="fas fa-pause me-1"></i>Pause
                        </button>
                        <button class="btn btn-danger btn-lg me-2" id="stop-btn" onclick="stopTimer()" disabled>
                            <i class="fas fa-stop me-1"></i>Stop
                        </button>
                        <button class="btn btn-info btn-lg" id="skip-btn" onclick="skipSession()" disabled>
                            <i class="fas fa-forward me-1"></i>Skip
                        </button>
                    </div>

                               <!-- Session Configuration -->
                               <div class="session-config-modern p-4 mb-4">
                                   <div class="row g-3">
                                       <div class="col-md-3">
                                           <label for="session-type-select" class="form-label-dark mb-2">
                                               <i class="fas fa-star me-1 text-primary"></i>Session Type
                                           </label>
                                           <select class="form-select" id="session-type-select">
                                               <option value="focus" data-duration="25">ðŸŽ¯ Focus</option>
                                               <option value="deep-work" data-duration="60">ðŸ§  Deep Work</option>
                                               <option value="review" data-duration="30">ðŸ“š Review</option>
                                               <option value="creative" data-duration="45">ðŸŽ¨ Creative</option>
                                               <option value="meeting" data-duration="45">ðŸ‘¥ Meeting</option>
                                               <option value="break" data-duration="5">â˜• Break</option>
                                           </select>
                                       </div>
                                       <div class="col-md-3">
                                           <label for="task-select" class="form-label-dark mb-2">
                                               <i class="fas fa-tasks me-1 text-primary"></i>Working on Task (Optional)
                                           </label>
                                           <select class="form-select" id="task-select">
                                               <option value="">Select a task...</option>
                                               {% for task in tasks %}
                                               <option value="{{ task.id }}">{{ task.title }}</option>
                                               {% endfor %}
                                           </select>
                                       </div>
                                       <div class="col-md-3">
                                           <label for="duration-select" class="form-label-dark mb-2">
                                               <i class="fas fa-clock me-1 text-primary"></i>Duration
                                           </label>
                                           <select class="form-select mb-2" id="duration-select">
                                               <option value="25">25 minutes (Standard)</option>
                                               <option value="20">20 minutes (Short)</option>
                                               <option value="30">30 minutes (Long)</option>
                                               <option value="45">45 minutes (Extended)</option>
                                               <option value="60">1 hour (Deep Work)</option>
                                               <option value="120">2 hours (Extended Session)</option>
                                               <option value="custom">Custom duration...</option>
                                           </select>
                                           <input type="number" class="form-control" id="custom-duration" placeholder="Enter minutes (1-300)" min="1" max="300" style="display: none;">
                                       </div>
                                       <div class="col-md-3">
                                           <label class="form-label-dark mb-2">
                                               <i class="fas fa-robot me-1 text-primary"></i>Auto Mode
                                           </label>
                                           <div class="form-check form-switch">
                                               <input class="form-check-input" type="checkbox" id="auto-mode-toggle">
                                               <label class="form-check-label" for="auto-mode-toggle">
                                                   <small>Auto-switch sessions</small>
                                               </label>
                                           </div>
                                       </div>
                                   </div>
                               </div>

                    <!-- Progress Indicator -->
                    <div class="progress mt-4" style="height: 8px;">
                        <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Session History -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>Recent Sessions
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_sessions %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Duration</th>
                                        <th>Status</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for session in recent_sessions %}
                                    <tr>
                                        <td>
                                            {% if session.session_type == 'work' %}
                                                <span class="badge bg-primary">Work</span>
                                            {% else %}
                                                <span class="badge bg-success">Break</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ session.duration or 0 }} min</td>
                                        <td>
                                            {% if session.completed %}
                                                <span class="badge bg-success">Completed</span>
                                            {% elif session.interrupted %}
                                                <span class="badge bg-warning">Interrupted</span>
                                            {% else %}
                                                <span class="badge bg-secondary">In Progress</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ session.created_at.strftime('%H:%M') }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center mb-0">No sessions yet. Start your first Pomodoro session!</p>
                    {% endif %}
                </div>
            </div>
        </div>

                    <!-- Sidebar: Today's Stats & Tips -->
                    <div class="col-lg-4">
                        <!-- Today's Statistics -->
                        <div class="card stats-card mb-4">
                            <div class="card-header bg-gradient-primary border-0">
                                <h5 class="card-title mb-0 text-white">
                                    <i class="fas fa-chart-bar me-2"></i>Today's Progress
                                </h5>
                            </div>
                            <div class="card-body bg-gradient-primary">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="h2 mb-2 text-white fw-bold">{{ today_stats.work_sessions }}</div>
                                        <small class="text-white-75">Work Sessions</small>
                                    </div>
                                    <div class="col-6">
                                        <div class="h2 mb-2 text-white fw-bold">{{ today_stats.break_sessions }}</div>
                                        <small class="text-white-75">Break Sessions</small>
                                    </div>
                                </div>
                                <hr class="my-3 border-white opacity-25">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="h4 mb-2 text-white fw-bold">{{ today_stats.total_work_time }}m</div>
                                        <small class="text-white-75">Work Time</small>
                                    </div>
                                    <div class="col-6">
                                        <div class="h4 mb-2 text-white fw-bold">{{ today_stats.completed_sessions }}</div>
                                        <small class="text-white-75">Completed</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pomodoro Tips -->
                        <div class="card tips-card mb-4">
                            <div class="card-header bg-transparent border-0">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-lightbulb me-2"></i>Pomodoro Tips
                                </h5>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-3">
                                        <i class="fas fa-check text-success me-2"></i>
                                        <small>Work for 25 minutes straight without distractions</small>
                                    </li>
                                    <li class="mb-3">
                                        <i class="fas fa-check text-success me-2"></i>
                                        <small>Take a 5-minute break to recharge</small>
                                    </li>
                                    <li class="mb-3">
                                        <i class="fas fa-check text-success me-2"></i>
                                        <small>Repeat 4 times, then take a longer break</small>
                                    </li>
                                    <li class="mb-3">
                                        <i class="fas fa-check text-success me-2"></i>
                                        <small>Use breaks for physical activity or relaxation</small>
                                    </li>
                                    <li>
                                        <i class="fas fa-check text-success me-2"></i>
                                        <small>Track your progress and adjust as needed</small>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- Settings Quick Access -->
                        <div class="card">
                            <div class="card-header bg-transparent border-0">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-cog me-2"></i>Timer Settings
                                </h5>
                            </div>
                            <div class="card-body settings-quick-access">
                                <div class="mb-3">
                                    <small class="text-white-50">Work Duration</small>
                                    <div class="fw-bold text-white">{{ user_settings.pomodoro_work_duration }} minutes</div>
                                </div>
                                <div class="mb-3">
                                    <small class="text-white-50">Short Break</small>
                                    <div class="fw-bold text-white">{{ user_settings.pomodoro_break_duration }} minutes</div>
                                </div>
                                <div class="mb-0">
                                    <small class="text-white-50">Long Break</small>
                                    <div class="fw-bold text-white">{{ user_settings.long_break_duration }} minutes</div>
                                </div>
                                <hr class="my-3 opacity-25">
                                <small class="text-white-50">Long break after {{ user_settings.sessions_until_long_break }} work sessions</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    </div>
</div>

<style>
.timer-display {
    margin: 2rem 0;
}

.timer-circle {
    width: 250px;
    height: 250px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    position: relative;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
}

.timer-circle.work-session {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
}

.timer-circle.break-session {
    background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
}

.timer-circle.paused {
    background: linear-gradient(135deg, #ffd43b 0%, #fab005 100%);
}

.timer-text {
    color: white;
    text-align: center;
}

.time-display {
    font-size: 3rem;
    font-weight: 300;
    margin-bottom: 0.5rem;
}

.session-info {
    font-size: 1rem;
    opacity: 0.9;
}

.timer-controls .btn {
    min-width: 100px;
}

.progress {
    margin-top: 1rem;
}

@media (max-width: 768px) {
    .timer-circle {
        width: 200px;
        height: 200px;
    }

    .time-display {
        font-size: 2.5rem;
    }

    .timer-controls .btn {
        min-width: 80px;
        margin-bottom: 0.5rem;
    }
}
</style>

<script>
let currentSession = null;
let timerInterval = null;
let isRunning = false;
let isPaused = false;
let totalSeconds = 0;
let elapsedSeconds = 0;

document.addEventListener('DOMContentLoaded', function() {
    // Check for active session on page load
    checkActiveSession();
});

// Timer Functions
function startTimer() {
    if (!isRunning) {
        if (!currentSession) {
            // Start new session
            startNewSession();
        } else {
            // Resume paused session
            resumeSession();
        }
    }
}

function pauseTimer() {
    if (isRunning && !isPaused) {
        isPaused = true;
        clearInterval(timerInterval);
        updateTimerDisplay();
        document.getElementById('pause-btn').disabled = true;
        document.getElementById('start-btn').disabled = false;
        document.getElementById('start-btn').innerHTML = '<i class="fas fa-play me-1"></i>Resume';
    }
}

function stopTimer() {
    if (confirm('Are you sure you want to stop this session?')) {
        interruptCurrentSession();
    }
}

function skipSession() {
    if (confirm('Skip this session and move to the next one?')) {
        completeCurrentSession();
    }
}

// Session Management
function startNewSession() {
    const taskId = document.getElementById('task-select').value;
    const duration = getSelectedDuration();

    if (!duration || duration < 1) {
        alert('Please select a valid duration.');
        return;
    }

    fetch('/pomodoro/start-session', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            session_type: getSelectedSessionType(),
            task_id: taskId || null,
            duration: duration
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentSession = data;
            startTimerCountdown(data.duration * 60);
            updateUIForSession('work', data.duration);
        }
    })
    .catch(error => {
        console.error('Error starting session:', error);
        alert('Failed to start session. Please try again.');
    });
}

function resumeSession() {
    // Calculate remaining time
    const elapsed = Math.floor((new Date() - new Date(currentSession.start_time)) / 1000);
    const remaining = (currentSession.duration * 60) - elapsed;

    if (remaining > 0) {
        startTimerCountdown(remaining);
        isPaused = false;
        document.getElementById('pause-btn').disabled = false;
        document.getElementById('start-btn').disabled = true;
    } else {
        // Session should have ended
        completeCurrentSession();
    }
}

function startTimerCountdown(seconds) {
    totalSeconds = seconds;
    elapsedSeconds = 0;
    isRunning = true;
    isPaused = false;

    updateTimerDisplay();

    timerInterval = setInterval(() => {
        elapsedSeconds++;
        const remaining = totalSeconds - elapsedSeconds;

        if (remaining <= 0) {
            completeCurrentSession();
            return;
        }

        updateTimerDisplay();
        updateProgressBar();
    }, 1000);

    document.getElementById('start-btn').disabled = true;
    document.getElementById('pause-btn').disabled = false;
    document.getElementById('stop-btn').disabled = false;
    document.getElementById('skip-btn').disabled = false;
}


function updateProgressBar() {
    const progress = (elapsedSeconds / totalSeconds) * 100;
    document.getElementById('progress-bar').style.width = `${progress}%`;
}

function completeCurrentSession() {
    if (!currentSession) return;

    clearInterval(timerInterval);
    isRunning = false;

    fetch(`/pomodoro/complete-session/${currentSession.session_id}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            playNotificationSound();

            const autoModeEnabled = document.getElementById('auto-mode-toggle').checked;

            if (autoModeEnabled) {
                // Auto-switch to next session type
                const nextSessionType = data.session_type === 'work' ? 'break' : 'work';
                autoStartNextSession(nextSessionType);
            } else {
                alert(`Session completed! Time for a ${data.session_type === 'work' ? 'break' : 'work session'}.`);
                resetUI();
            }
        }
    })
    .catch(error => {
        console.error('Error completing session:', error);
    });
}

function autoStartNextSession(nextType) {
    // Set the session type dropdown
    const sessionTypeSelect = document.getElementById('session-type-select');
    if (nextType === 'break') {
        sessionTypeSelect.value = 'break';
    } else {
        // Default to focus for work sessions
        sessionTypeSelect.value = 'focus';
    }

    // Update default duration
    updateSessionTypeDefault();

    // Auto-start after a brief delay
    setTimeout(() => {
        if (!isRunning) {
            startNewSession();
        }
    }, 1000); // 1 second delay
}

function playNotificationSound() {
    // Create a simple beep sound using Web Audio API
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 800; // Frequency in Hz
        oscillator.type = 'sine';

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    } catch (error) {
        console.log('Audio notification not supported:', error);
    }
}

function interruptCurrentSession() {
    if (!currentSession) return;

    clearInterval(timerInterval);
    isRunning = false;

    fetch(`/pomodoro/interrupt-session/${currentSession.session_id}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Session interrupted. Don\'t worry - progress is saved!');
            resetUI();
        }
    })
    .catch(error => {
        console.error('Error interrupting session:', error);
    });
}

function checkActiveSession() {
    fetch('/pomodoro/current-session')
    .then(response => response.json())
    .then(data => {
        if (data.active) {
            currentSession = data;
            const remaining = (data.duration * 60) - data.elapsed_seconds;

            if (remaining > 0) {
                startTimerCountdown(remaining);
                updateUIForSession(data.session_type, data.duration);
            } else {
                // Session should be completed
                completeCurrentSession();
            }
        }
    })
    .catch(error => {
        console.error('Error checking active session:', error);
    });
}

function updateUIForSession(sessionType, duration) {
    const sessionTypeSelect = document.getElementById('session-type-select');
    const selectedOption = sessionTypeSelect.options[sessionTypeSelect.selectedIndex];
    const sessionTypeName = selectedOption ? selectedOption.text : 'Focus Time';

    const title = sessionType === 'break' ? 'Break Time' : sessionTypeName;
    document.getElementById('timer-title').textContent = title;

    // Disable task selection during active session
    document.getElementById('task-select').disabled = true;
    document.getElementById('duration-select').disabled = true;
    document.getElementById('custom-duration').disabled = true;
    document.getElementById('session-type-select').disabled = true;
    document.getElementById('auto-mode-toggle').disabled = true;
}

function resetUI() {
    currentSession = null;
    isRunning = false;
    isPaused = false;

    document.getElementById('timer-title').textContent = 'Ready to Start';
    updateTimerDisplayToSelectedDuration();
    document.getElementById('session-info').textContent = 'Work Session';
    document.getElementById('progress-bar').style.width = '0%';

    document.getElementById('timer-circle').className = 'timer-circle';

    document.getElementById('start-btn').disabled = false;
    document.getElementById('start-btn').innerHTML = '<i class="fas fa-play me-1"></i>Start';
    document.getElementById('pause-btn').disabled = true;
    document.getElementById('stop-btn').disabled = true;
    document.getElementById('skip-btn').disabled = true;

    document.getElementById('task-select').disabled = false;
    document.getElementById('duration-select').disabled = false;
    document.getElementById('custom-duration').disabled = false;
    document.getElementById('session-type-select').disabled = false;
    document.getElementById('auto-mode-toggle').disabled = false;
}

function getSelectedDuration() {
    const selectValue = document.getElementById('duration-select').value;
    if (selectValue === 'custom') {
        const customValue = parseInt(document.getElementById('custom-duration').value);
        return isNaN(customValue) || customValue < 1 ? 25 : Math.min(customValue, 300);
    }
    return parseInt(selectValue);
}

function getSelectedSessionType() {
    const sessionTypeValue = document.getElementById('session-type-select').value;
    return sessionTypeValue === 'break' ? 'break' : 'work';
}

function updateSessionTypeDefault() {
    const select = document.getElementById('session-type-select');
    const selectedOption = select.options[select.selectedIndex];
    const defaultDuration = selectedOption.getAttribute('data-duration');

    if (defaultDuration && document.getElementById('duration-select').value !== 'custom') {
        document.getElementById('duration-select').value = defaultDuration;
        updateTimerDisplayToSelectedDuration();
    }
}

function updateTimerDisplayToSelectedDuration() {
    const selectedDuration = getSelectedDuration();
    const hours = Math.floor(selectedDuration / 60);
    const minutes = selectedDuration % 60;

    let timeString;
    if (hours > 0) {
        timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:00`;
    } else {
        timeString = `${minutes.toString().padStart(2, '0')}:00`;
    }

    document.getElementById('time-display').textContent = timeString;
}

function toggleCustomDuration() {
    const select = document.getElementById('duration-select');
    const customInput = document.getElementById('custom-duration');

    if (select.value === 'custom') {
        customInput.style.display = 'block';
        customInput.focus();
    } else {
        customInput.style.display = 'none';
    }
}

function updateTimerDisplay() {
    const remaining = totalSeconds - elapsedSeconds;
    const hours = Math.floor(Math.abs(remaining) / 3600);
    const minutes = Math.floor((Math.abs(remaining) % 3600) / 60);
    const seconds = Math.abs(remaining) % 60;

    let timeString;
    if (hours > 0) {
        timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    } else {
        timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    document.getElementById('time-display').textContent = timeString;

    // Update circle color based on session type and state
    const circle = document.getElementById('timer-circle');
    if (isPaused) {
        circle.className = 'timer-circle paused';
        document.getElementById('session-info').textContent = 'Paused';
    } else if (currentSession && currentSession.session_type === 'break') {
        circle.className = 'timer-circle break-session';
        document.getElementById('session-info').textContent = 'Break Time';
    } else {
        circle.className = 'timer-circle work-session';
        document.getElementById('session-info').textContent = 'Focus Time';
    }
}

// Initialize timer display
updateTimerDisplayToSelectedDuration();

// Update display when duration changes
document.getElementById('duration-select').addEventListener('change', function() {
    toggleCustomDuration();
    updateTimerDisplayToSelectedDuration();
});

document.getElementById('custom-duration').addEventListener('input', updateTimerDisplayToSelectedDuration);

// Update when session type changes
document.getElementById('session-type-select').addEventListener('change', updateSessionTypeDefault);
</script>
{% endblock %}