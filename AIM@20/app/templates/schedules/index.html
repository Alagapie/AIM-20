{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm bg-gradient-schedules text-white">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h2 mb-1">
                                <i class="fas fa-calendar-alt me-2"></i>Smart Schedules
                            </h1>
                            <p class="mb-0 opacity-75">
                                AI-powered study schedules optimized for maximum productivity
                            </p>
                        </div>
                        <div class="d-flex gap-2">
                            <div class="stats-widget">
                                <div class="h4 mb-0" id="total-schedules">0</div>
                                <small class="opacity-75">Total Schedules</small>
                            </div>
                            <div class="stats-widget">
                                <div class="h4 mb-0" id="study-hours">0h</div>
                                <small class="opacity-75">Study Hours</small>
                            </div>
                            <a href="{{ url_for('schedules.generate') }}" class="btn btn-light btn-lg">
                                <i class="fas fa-magic me-2"></i>Generate AI Schedule
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex gap-3">
                            <div class="filter-btn active" data-filter="all">
                                <i class="fas fa-list me-1"></i>All Schedules
                            </div>
                            <div class="filter-btn" data-filter="today">
                                <i class="fas fa-sun me-1"></i>Today
                            </div>
                            <div class="filter-btn" data-filter="week">
                                <i class="fas fa-calendar-week me-1"></i>This Week
                            </div>
                            <div class="filter-btn" data-filter="month">
                                <i class="fas fa-calendar-alt me-1"></i>This Month
                            </div>
                        </div>
                        <div class="search-box">
                            <input type="text" class="form-control form-control-sm" placeholder="Search schedules..." id="schedule-search">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedules Grid -->
    <div class="row g-4" id="schedules-grid">
        {% if schedules.items %}
            {% for schedule in schedules.items %}
            <div class="col-lg-6 col-xl-4">
                <div class="schedule-card card border-0 shadow-sm h-100">
                    <div class="card-header bg-light border-0 d-flex justify-content-between align-items-center">
                        <div class="schedule-date">
                            <div class="h6 mb-0">{{ schedule.date.strftime('%b %d') }}</div>
                            <small class="text-muted">{{ schedule.date.strftime('%A') }}</small>
                        </div>
                        {% if schedule.generated_by_ai %}
                        <span class="badge bg-success">
                            <i class="fas fa-robot me-1"></i>AI
                        </span>
                        {% else %}
                        <span class="badge bg-secondary">
                            <i class="fas fa-cogs me-1"></i>Manual
                        </span>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="schedule-icon me-3">
                                <i class="fas fa-calendar-check text-primary fa-2x"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-1">
                                    {{ schedule.total_study_time // 60 }}h {{ schedule.total_study_time % 60 }}m Study Time
                                </h6>
                                <small class="text-muted">{{ schedule.tasks|length }} tasks scheduled</small>
                            </div>
                        </div>

                        <!-- Progress indicator -->
                        <div class="schedule-progress mb-3">
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar bg-primary" style="width: 0%"></div>
                            </div>
                            <small class="text-muted">0 of {{ schedule.tasks|length }} tasks completed</small>
                        </div>

                        <!-- Task preview -->
                        {% if schedule.tasks %}
                        <div class="task-preview mb-3">
                            {% for schedule_task in schedule.tasks[:3] %}
                            <div class="task-item-small mb-1">
                                <i class="fas fa-circle text-{{ 'danger' if schedule_task.task.priority == 'high' else 'warning' if schedule_task.task.priority == 'medium' else 'success' }} fa-xs me-2"></i>
                                <small class="text-truncate">{{ schedule_task.task.title }}</small>
                            </div>
                            {% endfor %}
                            {% if schedule.tasks|length > 3 %}
                            <small class="text-muted">+{{ schedule.tasks|length - 3 }} more tasks</small>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Quick stats -->
                        <div class="schedule-stats d-flex justify-content-between">
                            <div class="stat-item">
                                <i class="fas fa-clock text-muted me-1"></i>
                                <small>{{ schedule.total_study_time }}min</small>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-tasks text-muted me-1"></i>
                                <small>{{ schedule.tasks|length }}</small>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-flag text-muted me-1"></i>
                                <small>
                                    {% set high_count = schedule.tasks|selectattr('task.priority', 'equalto', 'high')|list|length %}
                                    {% set med_count = schedule.tasks|selectattr('task.priority', 'equalto', 'medium')|list|length %}
                                    {% set low_count = schedule.tasks|selectattr('task.priority', 'equalto', 'low')|list|length %}
                                    {{ high_count }}H {{ med_count }}M {{ low_count }}L
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-0 pt-0">
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('schedules.view', schedule_id=schedule.id) }}" class="btn btn-primary btn-sm flex-fill">
                                <i class="fas fa-eye me-1"></i>View
                            </a>
                            <button class="btn btn-outline-success btn-sm start-schedule-btn" data-schedule-id="{{ schedule.id }}">
                                <i class="fas fa-play me-1"></i>Start
                            </button>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item duplicate-btn" href="#" data-schedule-id="{{ schedule.id }}">
                                        <i class="fas fa-copy me-2"></i>Duplicate
                                    </a></li>
                                    <li><a class="dropdown-item export-btn" href="#" data-schedule-id="{{ schedule.id }}">
                                        <i class="fas fa-download me-2"></i>Export
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger delete-btn" href="#" data-schedule-id="{{ schedule.id }}">
                                        <i class="fas fa-trash me-2"></i>Delete
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="empty-state-card card border-0 shadow-sm">
                    <div class="card-body text-center py-5">
                        <div class="empty-state-icon mb-4">
                            <i class="fas fa-calendar-plus fa-5x text-muted"></i>
                        </div>
                        <h4 class="text-muted mb-3">No schedules yet</h4>
                        <p class="text-muted mb-4">
                            Create your first AI-powered study schedule to boost your productivity and stay organized.
                        </p>
                        <div class="d-flex justify-content-center gap-3">
                            <a href="{{ url_for('schedules.generate') }}" class="btn btn-primary btn-lg">
                                <i class="fas fa-magic me-2"></i>Generate AI Schedule
                            </a>
                            <a href="{{ url_for('tasks.index') }}" class="btn btn-outline-primary btn-lg">
                                <i class="fas fa-plus me-2"></i>Add Tasks First
                            </a>
                        </div>
                        <div class="mt-4">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Tip: The AI analyzes your tasks, energy patterns, and study habits to create optimal schedules.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Pagination -->
    {% if schedules.has_prev or schedules.has_next %}
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="Schedule pagination">
                <ul class="pagination justify-content-center">
                    {% if schedules.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('schedules.index', page=schedules.prev_num) }}">
                            <i class="fas fa-chevron-left me-1"></i>Previous
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link"><i class="fas fa-chevron-left me-1"></i>Previous</span>
                    </li>
                    {% endif %}

                    {% for page_num in schedules.iter_pages() %}
                    {% if page_num %}
                    <li class="page-item {{ 'active' if page_num == schedules.page else '' }}">
                        <a class="page-link" href="{{ url_for('schedules.index', page=page_num) }}">
                            {{ page_num }}
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    {% endfor %}

                    {% if schedules.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('schedules.index', page=schedules.next_num) }}">
                            Next<i class="fas fa-chevron-right ms-1"></i>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">Next<i class="fas fa-chevron-right ms-1"></i></span>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
</div>

<!-- Advanced Schedule Index Styles -->
<style>
/* Gradient background for header */
.bg-gradient-schedules {
    background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
}

/* Stats widgets */
.stats-widget {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 12px 16px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
}

/* Filter buttons */
.filter-btn {
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #6c757d;
}

.filter-btn:hover {
    background: #e9ecef;
    color: #495057;
}

.filter-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

/* Search box */
.search-box {
    min-width: 250px;
}

/* Schedule cards */
.schedule-card {
    transition: all 0.3s ease;
}

.schedule-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.schedule-date {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px;
    padding: 8px 12px;
    text-align: center;
    min-width: 60px;
}

.schedule-icon {
    background: rgba(0, 123, 255, 0.1);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Progress bars */
.schedule-progress .progress {
    background: #e9ecef;
    border-radius: 2px;
}

/* Task items */
.task-item-small {
    display: flex;
    align-items: center;
    padding: 4px 0;
}

.task-item-small .fa-circle {
    font-size: 0.6rem;
}

/* Stats */
.schedule-stats {
    border-top: 1px solid #f8f9fa;
    padding-top: 12px;
}

.stat-item {
    text-align: center;
    flex: 1;
}

/* Empty state */
.empty-state-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 2px dashed #dee2e6;
}

.empty-state-icon {
    opacity: 0.5;
}

/* Card footer actions */
.card-footer .btn {
    border-radius: 6px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .bg-gradient-schedules .d-flex {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }

    .stats-widget {
        text-align: center;
    }

    .filter-btn {
        padding: 6px 12px;
        font-size: 0.875rem;
    }

    .search-box {
        min-width: 200px;
    }

    .schedule-card .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
}

/* Loading states */
.schedule-card.loading {
    opacity: 0.6;
    pointer-events: none;
}

.schedule-card.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid #007bff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Priority colors */
.priority-high { border-left: 4px solid #dc3545; }
.priority-medium { border-left: 4px solid #ffc107; }
.priority-low { border-left: 4px solid #28a745; }
</style>

<!-- Interactive JavaScript -->
<script>
// Global variables
let schedulesData = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializePage();
    setupEventListeners();
});

// Initialize page data
function initializePage() {
    // Load schedule statistics
    loadScheduleStats();

    // Initialize filter buttons
    initializeFilters();

    // Initialize search
    initializeSearch();
}

// Load schedule statistics
function loadScheduleStats() {
    // This would typically fetch from an API
    // For now, calculate from template data
    const scheduleCards = document.querySelectorAll('.schedule-card');
    const totalSchedules = scheduleCards.length;
    let totalStudyMinutes = 0;

    scheduleCards.forEach(card => {
        const timeText = card.querySelector('.card-title')?.textContent || '0h 0m';
        const hours = parseInt(timeText.match(/(\d+)h/)?.[1] || 0);
        const minutes = parseInt(timeText.match(/(\d+)m/)?.[1] || 0);
        totalStudyMinutes += (hours * 60) + minutes;
    });

    const totalHours = Math.floor(totalStudyMinutes / 60);

    document.getElementById('total-schedules').textContent = totalSchedules;
    document.getElementById('study-hours').textContent = totalHours + 'h';
}

// Setup event listeners
function setupEventListeners() {
    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', handleFilterClick);
    });

    // Schedule action buttons
    document.addEventListener('click', handleScheduleActions);
}

// Initialize filters
function initializeFilters() {
    // Mark active filter
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
}

// Handle filter clicks
function handleFilterClick(event) {
    const filterType = event.target.closest('.filter-btn').dataset.filter;
    filterSchedules(filterType);
}

// Filter schedules
function filterSchedules(filterType) {
    const scheduleCards = document.querySelectorAll('.schedule-card');

    scheduleCards.forEach(card => {
        const scheduleDate = new Date(card.querySelector('.schedule-date .h6').textContent + ' 2024'); // Add year for date parsing
        const today = new Date();
        let show = true;

        switch(filterType) {
            case 'today':
                show = scheduleDate.toDateString() === today.toDateString();
                break;
            case 'week':
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                show = scheduleDate >= weekStart && scheduleDate <= weekEnd;
                break;
            case 'month':
                show = scheduleDate.getMonth() === today.getMonth() &&
                       scheduleDate.getFullYear() === today.getFullYear();
                break;
            default:
                show = true;
        }

        card.style.display = show ? 'block' : 'none';
    });
}

// Initialize search
function initializeSearch() {
    const searchInput = document.getElementById('schedule-search');
    let searchTimeout;

    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const query = this.value.toLowerCase().trim();
            searchSchedules(query);
        }, 300);
    });
}

// Search schedules
function searchSchedules(query) {
    const scheduleCards = document.querySelectorAll('.schedule-card');

    if (!query) {
        scheduleCards.forEach(card => card.style.display = 'block');
        return;
    }

    scheduleCards.forEach(card => {
        const title = card.querySelector('.card-title')?.textContent.toLowerCase() || '';
        const date = card.querySelector('.schedule-date')?.textContent.toLowerCase() || '';
        const tasks = Array.from(card.querySelectorAll('.task-item-small small')).map(t => t.textContent.toLowerCase()).join(' ');

        const matches = title.includes(query) || date.includes(query) || tasks.includes(query);
        card.style.display = matches ? 'block' : 'none';
    });
}

// Handle schedule actions
function handleScheduleActions(event) {
    let target = event.target;

    // Handle clicks on dropdown menu items and buttons
    if (target.tagName === 'I' || target.tagName === 'SPAN') {
        target = target.closest('a, button');
    }

    if (!target) return;

    const isStartBtn = target.classList.contains('start-schedule-btn');
    const isDuplicateBtn = target.classList.contains('duplicate-btn');
    const isExportBtn = target.classList.contains('export-btn');
    const isDeleteBtn = target.classList.contains('delete-btn');

    if (!isStartBtn && !isDuplicateBtn && !isExportBtn && !isDeleteBtn) return;

    event.preventDefault();

    const scheduleId = target.dataset.scheduleId;
    if (!scheduleId) return;

    let action;
    if (isStartBtn) action = 'start';
    else if (isDuplicateBtn) action = 'duplicate';
    else if (isExportBtn) action = 'export';
    else if (isDeleteBtn) action = 'delete';

    switch(action) {
        case 'start':
            startPomodoroFromSchedule(scheduleId);
            break;
        case 'duplicate':
            duplicateSchedule(scheduleId);
            break;
        case 'export':
            exportSchedule(scheduleId);
            break;
        case 'delete':
            deleteSchedule(scheduleId);
            break;
    }
}

// Action functions
function startPomodoroFromSchedule(scheduleId) {
    // Redirect to pomodoro with the schedule ID as a parameter
    showNotification('Starting Pomodoro session...', 'info');
    window.location.href = "{{ url_for('pomodoro.index') }}" + "?schedule=" + scheduleId;
}

function duplicateSchedule(scheduleId) {
    if (confirm('Create a copy of this schedule for tomorrow?')) {
        showNotification('Duplicating schedule...', 'info');

        // Make AJAX call to duplicate
        fetch(`/schedules/${scheduleId}/duplicate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                return response.json();
            }
        })
        .then(data => {
            if (data && data.error) {
                showNotification(data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error duplicating schedule', 'error');
        });
    }
}

function exportSchedule(scheduleId) {
    showNotification('Preparing export...', 'info');

    // Trigger download by navigating to export URL
    const exportUrl = `/schedules/${scheduleId}/export`;
    window.open(exportUrl, '_blank');

    showNotification('Schedule exported successfully!', 'success');
}

function deleteSchedule(scheduleId) {
    const scheduleCard = document.querySelector(`[data-schedule-id="${scheduleId}"]`).closest('.schedule-card');
    const scheduleTitle = scheduleCard.querySelector('.schedule-date .h6').textContent;

    if (confirm(`Are you sure you want to delete the schedule for ${scheduleTitle}? This action cannot be undone.`)) {
        showNotification('Deleting schedule...', 'info');

        // Make AJAX call to delete
        fetch(`/schedules/${scheduleId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                return response.text();
            }
        })
        .then(() => {
            // Remove card and update stats
            scheduleCard.remove();
            loadScheduleStats();
            showNotification('Schedule deleted successfully!', 'success');
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error deleting schedule', 'error');
        });
    }
}

// Notification system
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(notification);

    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}
</script>
{% endblock %}